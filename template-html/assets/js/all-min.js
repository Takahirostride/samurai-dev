function Point(a,b){this.x=a||0;this.y=b||0}var Route=function(){this.startTime=0;this.totalTime=0;this.sx=0;this.sy=0;this.sw=0;this.sh=0;this.x=0;this.y=0};var Common={TUCK_TOOLBAR:lesson_data.info.boolTuckToolBar,LESSON_WIDTH:lesson_data.info.bgSize.w,LESSON_HEIGHT:lesson_data.info.bgSize.h,FLICKER_TIME:lesson_data.info.flickerTime,INFO_NAME:lesson_data.info.name,INFO_AUTHOR:lesson_data.info.author,INFO_DATE:lesson_data.info.date,INFO_SCORM_VERSION:lesson_data.info.scormVersion,INFO_SCORM_COMPMODE:lesson_data.info.completionMode,MESG_DIV_ID:"msg",REPORT_NAN:"-",REPORT_DIV_ID:"reportContent",MAXTRIES:lesson_data.info.maxTries,EXAM_INTERVAL:lesson_data.info.examInterval,HARD_LEVEL:lesson_data.info.level,REQUIRE_LINE:lesson_data.info.requireLine,MAIL:lesson_data.info.mail,SCALE_RATIO:1,DATA_PATH:"data/",CANVAS_ID:"lessonCanvas",EDIT_DIV_ID:"edits",CURRENT_EXPLORER:"",EDIT_BOX_NEED_SHOW:false,FOCUS_EDIT_BOX:null,CANVAS_SCALE:1,CANVAS_SCALE_X:0,CANVAS_SCALE_Y:0,CANVAS_AFTER_SCALE:1,CANVAS_AFTER_SCALE_X:0,CANVAS_AFTER_SCALE_Y:0,IS_INDEX:true,MEDIA_WAIT_ERROR:2000,MEDIA_LOADING:500,ERROR_VIDEO:"res/_error.mp4",ERROR_AUDIO:"res/_error.mp3",VIDEO_OBJ_ID:0,IS_IPHONE:false,IS_IPAD:false,VER_IOS:0,GetRelativePath:function(){var a="";try{var c=document.getElementById("html5body").getAttribute("src");if(c!=null&&c!=undefined){a=c}}catch(b){console.log("路径读取失败.")}Common.DATA_PATH=a+Common.DATA_PATH;Common.ERROR_VIDEO=a+Common.ERROR_VIDEO;Common.ERROR_AUDIO=a+Common.ERROR_AUDIO},checkIOS:function(){var c=navigator.userAgent;if(Common.IS_IPHONE||Common.IS_IPAD){var b=c.match(/OS \d+_\d[_\d]* like Mac OS X/i);var d=/\d+/g;var a=d.exec(b);Common.VER_IOS=a[0]}},GetBrowserVersion:function(){var a=navigator.userAgent;if(a.match(/iPhone/i)!=null){Common.IS_IPHONE=true;Common.CURRENT_EXPLORER=ExplorerInfo.IOS;Common.checkIOS()}else{if(a.match(/iPad/i)!=null){Common.IS_IPAD=true;Common.CURRENT_EXPLORER=ExplorerInfo.IOS;Common.checkIOS()}else{if(a.match(/Android/i)!=null){Common.CURRENT_EXPLORER=ExplorerInfo.ANDROID}else{if("ActiveXObject" in window){if(a.match(/rv:11.0/i)!=null){if(this.isActivexEnabled()){Common.CURRENT_EXPLORER=ExplorerInfo.DESKTOP_IE}else{Common.CURRENT_EXPLORER=ExplorerInfo.METRO_IE}}else{Common.CURRENT_EXPLORER=ExplorerInfo.DESKTOP_IE}}else{Common.CURRENT_EXPLORER=ExplorerInfo.OTHERS}}}}},isActivexEnabled:function(){var a=null;try{return !!new ActiveXObject("htmlfile")}catch(b){return false}},IsTouchDevice:function(){if(CURRENT_EXPLORER==ExplorerInfo.METRO_IE||CURRENT_EXPLORER==ExplorerInfo.IOS){return true}else{return false}},GetCss:function(b,a){return b.currentStyle?b.currentStyle[a]:document.defaultView.getComputedStyle(b,false)[a]},checkIndex:function(){if(Common.getMetaContent()!="index.html"){Common.IS_INDEX=false}else{Common.IS_INDEX=true}},getMetaContent:function(){return document.getElementsByTagName("meta")["start-page-name"]["content"]},getMsgBoxElement:function(){var a=document.getElementById(Common.MESG_DIV_ID);return a},getReportElement:function(){var a=document.getElementById(Common.REPORT_DIV_ID);return a},getScaleRatio:function(g,a){var e=1;var b=g/this.LESSON_WIDTH;var d=a/this.LESSON_HEIGHT;var c=this.LESSON_WIDTH/this.LESSON_HEIGHT;var f=g/a;if(c>f){e=b}else{e=d}return e},autoResize:function(e,b,d){var a=this.LESSON_WIDTH*this.SCALE_RATIO;var c=this.LESSON_HEIGHT*this.SCALE_RATIO;d.width=a;d.height=c;return{width:a,height:c}},compare:function(a){return function(e,d){var c=e[a];var b=d[a];if(!isNaN(Number(c))&&!isNaN(Number(b))){c=Number(c);b=Number(b)}if(c<b){return -1}else{if(c>b){return 1}else{return 0}}}},getTimeNow:function(){return +new Date()},refontsize:function(d,b,f){var e=document.getElementsByClassName(d);var c=e.length;for(var a=0;a<c;a++){e[a].style.fontSize=b*f}},isScoreBook:function(){if(typeof(mode_config)!="undefined"){return true}else{return false}},isScorm:function(){if(typeof(Common.INFO_SCORM_VERSION)!="undefined"){return true}else{return false}},checkHtml5:function(){if(typeof(Worker)!=="undefined"||Common.IS_IPHONE||Common.IS_IPAD){return true}else{return false}},getFileName:function(a){return a.substr(a.lastIndexOf("/")+1,a.length)}};var Menu_LoadFlag={loading:"loading",error:"error",ok:"ok"};var Menu_Mode={index:-1,auto:0,lecture:1,exercise:2,examination:3};var ExplorerInfo={DESKTOP_IE:"desktopIE",METRO_IE:"metroIe",IOS:"ios",ANDROID:"android",OTHERS:"others"};var EventResult={Ineffective:-1,Incorrectly:0,Correctly:1,CorrectlyButIneffective:2,IncorrectlyButIneffective:3,PointInEditBox:4};var Menu_Action={unknown:-1,mouseAction:0,keyAction:1,editAction:2};var OperationResult=function(){this.actionName="";this.eventResult=EventResult.Ineffective;this.next=undefined;this.actionType=Menu_Action.unknown};var MouseActionType={running:-1,stop:0};var ClickEventType={mouse:0,touchPoint:1};window.onclick=function(a){if(a.target.nodeName=="BUTTON"){a.target.blur()}};Common.GetBrowserVersion();Common.checkIndex();Common.GetRelativePath();document.oncontextmenu=new Function("return false");document.onmousedown=false;var mediaPool=new Array();function CreateMediaPool(a){for(var b=0;b<a;b++){var d=document.createElement("video");d.style.display="none";d.src=Common.ERROR_VIDEO;d.load();var c=new Audio();c.src=Common.ERROR_VIDEO;c.load();mediaPool[b]=new Array();mediaPool[b]["video"]=d;mediaPool[b]["audio"]=c;document.body.appendChild(d)}}function ReleaseMedia(a){var d=mediaPool[a];var c=d.video;var b=d.audio;if(c.src.indexOf(Common.getFileName(Common.ERROR_VIDEO))!=-1){return}c.src=Common.ERROR_VIDEO;c.load();b.src=Common.ERROR_VIDEO;b.load()}function SeekMedia(a,f){var g=mediaPool[a];var c=g.video;var b=g.audio;try{c.currentTime=f;b.currentTime=f}catch(d){}}function Bezier(f){this.pts=f;this.cps=c(this.pts);function e(h,g){return Math.sqrt(Math.pow(h.x-g.x,2)+Math.pow(h.y-g.y,2))}function a(h,g){return[g.x-h.x,g.y-h.y]}function d(n,l,j){var h=0.5;var g=a(n,j);var k=e(n,l);var m=e(l,j);var i=k+m;return[new Point(l.x-g[0]*h*k/i,l.y-g[1]*h*k/i),new Point(l.x+g[0]*h*m/i,l.y+g[1]*h*m/i)]}function c(k){var h=k.length;var j=[];j[0]=k[0];for(var g=0;g<h-2;g++){j=j.concat(d(k[g],k[g+1],k[g+2]))}if(h==2){j[h-1]=k[h-1]}else{j[j.length]=k[h-1]}return j}function b(m,o){var h,l,j;var p,k,i;var n,g;j=3*(m[1].x-m[0].x);l=3*(m[2].x-m[1].x)-j;h=m[3].x-m[0].x-j-l;i=3*(m[1].y-m[0].y);k=3*(m[2].y-m[1].y)-i;p=m[3].y-m[0].y-i-k;n=o*o;g=n*o;return new Point((h*g)+(l*n)+(j*o)+m[0].x,(p*g)+(k*n)+(i*o)+m[0].y)}this.computePointsInCurve=function(g,m){var l=[this.pts[g],this.cps[2*g],this.cps[2*g+1],this.pts[g+1]];var j=[];var k=1/(m-1);for(var h=0;h<m-1;h++){j[h]=b(l,h*k)}return j}}(function(e){var c=function(i,h){if(typeof(h)=="undefined"){h={}}this.init(i,h)},f=c.prototype,g=function(h,k,i){var j=document.createElement(h),l;for(l in i){j[l]=i[l]}if(typeof(k)!=="undefined"){k.appendChild(j)}return j},b=function(i,h){for(var j in h){i.style[j]=h[j]}return i},d=function(i,h){for(var j in h){i.setAttribute(j,h[j])}return i},a=function(k,h,j,i){k.save();k.translate(h,j);k.rotate(i);k.translate(-h,-j);k.beginPath()};f.init=function(j,i){try{if(document.getElementById(j)!==undefined){this.mum=document.getElementById(j)}else{this.mum=document.body}}catch(h){this.mum=document.body}i.id=typeof(i.id)!=="undefined"?i.id:"canvasLoader";this.cont=g("div",this.mum,{id:i.id});this.can=g("canvas",this.cont);this.con=this.can.getContext("2d");this.cCan=b(g("canvas",this.cont),{display:"none"});this.cCon=this.cCan.getContext("2d");this.cRGB=this.getRGB(this.color);this.draw();b(this.cont,{display:"none"})};f.cont={};f.can={};f.con={};f.cCan={};f.cCon={};f.timer={};f.activeId=0;f.diameter=35;f.setDiameter=function(h){this.diameter=Math.round(Math.abs(h));this.redraw()};f.color="#000000";f.cRGB={};f.getRGB=function(h){h=h.charAt(0)==="#"?h.substring(1,7):h;return{r:parseInt(h.substring(0,2),16),g:parseInt(h.substring(2,4),16),b:parseInt(h.substring(4,6),16)}};f.density=10;f.range=0.7;f.speed=1;f.fps=17;f.stateFlag=Menu_LoadFlag.loading;f.setState=function(h){if(h==Menu_LoadFlag.ok){this.hide()}else{if(this.stateFlag!=h){this.stateFlag=h;this.redraw()}this.show()}};f.draw=function(){var k=0,w,t,s,j,n,u=this.density,h=Math.round(u*this.range),m,l=0,q=1000,r=this.cCon,p=this.diameter,o=0.47;r.clearRect(0,0,q,q);d(this.can,{width:p,height:p});d(this.cCan,{width:p,height:p});if(this.stateFlag==Menu_LoadFlag.loading){while(k<u){m=k<=h?1-((1-l)/h*k):m=l;j=270-360/u*k;n=j/180*Math.PI;r.fillStyle="rgba("+this.cRGB.r+","+this.cRGB.g+","+this.cRGB.b+","+m.toString()+")";w=p*0.07;t=p*o+Math.cos(n)*(p*o-w)-p*o;s=p*o+Math.sin(n)*(p*o-w)-p*o;r.beginPath();r.arc(p*0.5+t,p*0.5+s,w*m,0,Math.PI*2,false);r.closePath();r.fill();r.restore();++k}}else{var v=r.createLinearGradient(0,0,p*0.5,0);v.addColorStop(0,this.color);v.addColorStop(1,"#cccccc");r.fillStyle=v;r.beginPath();a(r,p*0.5,p*0.5,45/180*Math.PI);r.arc(p*0.5,p*0.5,p*0.5,0,Math.PI*2,false);r.arc(p*0.5,p*0.5,p*0.4,0,Math.PI*2,true);r.fillRect(p*0.1,p*0.45,p*0.8,p*0.1);r.closePath();r.fill();r.restore()}this.tick(true)};f.tick=function(i){var j=this.con,h=this.diameter;j.clearRect(0,0,h,h);if(this.stateFlag==Menu_LoadFlag.loading){if(!i){this.activeId+=360/this.density*this.speed}a(j,h*0.5,h*0.5,this.activeId/180*Math.PI)}j.drawImage(this.cCan,0,0,h,h);j.restore()};f.clean=function(){this.con.clearRect(0,0,1000,1000)};f.redraw=function(){this.clean();this.draw()};f.show=function(){if(typeof(this.timer)!=="number"){var h=this;this.timer=setInterval(function(){h.tick()},Math.round(1000/this.fps));b(this.cont,{display:"block"})}};f.hide=function(){if(typeof(this.timer)==="number"){clearInterval(this.timer);delete this.timer;b(this.cont,{display:"none"})}};e.CanvasLoader=c}(window));var control_bar_box=document.getElementById("control_bar_box");var controlbarHtml=document.getElementById("controlbar");var controlbar_playorpause=document.getElementById("controlbar_playorpause");var controlbar_goback=document.getElementById("controlbar_goback");var controlbar_hide=document.getElementById("controlbar_hide");var controlbar_show=document.getElementById("controlbar_show");var controlbar_volumeuporoff=document.getElementById("controlbar_volumeuporoff");var controlbar_tofirststep=document.getElementById("controlbar_tofirststep");var controlbar_tolaststep=document.getElementById("controlbar_tolaststep");var controlbar_topreviousstep=document.getElementById("controlbar_topreviousstep");var controlbar_tonextstep=document.getElementById("controlbar_tonextstep");var controlbar_progressbarbox=document.getElementById("controlbar_progressbarbox");var controlbar_progressbar=document.getElementById("controlbar_progressbar");var cb_curindex=document.getElementById("cb_curindex");var cb_curtime=document.getElementById("cb_curtime");var controlbar_adaptive=document.getElementById("controlbar_adaptive");var controlbar_tostop=document.getElementById("controlbar_tostop");var ControlBar=function(a){this.lesson=a;this.isvolumeup=true;this.basecss="player-button ";this.stepbynum=null;this.curmode=-1;this.lessontime=0;this.iscontroling=false};ControlBar.prototype={InitBar:function(){for(var a=0;a<this.lesson.steps.length;a++){this.lessontime+=this.lesson.steps[a].totalTime}},OnResize:function(a){},ShowBar:function(a){this.curmode=a;if(a<0){control_bar_box.style.display="none";controlbar_show.style.display="none"}else{var e=document.getElementsByClassName("player-button");var b=e.length;for(var d=0;d<b;d++){var c=e[d];var f=(c.id.split("_"))[1];if(!DoWorkByMode(f,a)){c.style.opacity=0.1;c.style.cursor="not-allowed"}else{c.style.opacity=1;c.style.cursor="pointer"}}if(DoWorkByMode("progress-bar-indicator",a)){controlbar_progressbar.style.cursor="pointer"}else{controlbar_progressbar.style.cursor="not-allowed"}if(Common.IS_IPHONE||Common.IS_IPAD){controlbar_volumeuporoff.style.opacity=0.1;controlbar_volumeuporoff.style.cursor="not-allowed"}else{controlbar_volumeuporoff.style.opacity=1;controlbar_volumeuporoff.style.cursor="pointer"}if(Common.TUCK_TOOLBAR){this.HideMe()}else{this.ShowMe()}this.OnPlay()}},PlayOrPause:function(){if(!this.lesson.flag_Paused){this.OnPause()}else{this.OnPlay()}},OnReplay:function(){setMode(this.lesson.mode)},OnPlay:function(){controlbar_playorpause.className=this.basecss+"icon-pause";this.lesson.ctrl_paused=false;this.lesson.play()},OnPause:function(){controlbar_playorpause.className=this.basecss+"icon-play";this.lesson.ctrl_paused=true;this.lesson.pause()},GoBack:function(){setMode(Menu_Mode.index)},ShowMe:function(){Common.TUCK_TOOLBAR=false;control_bar_box.style.display="block";this.UpdateProgressbarS(this.lesson.durationStep);controlbar_show.style.display="none"},HideMe:function(){Common.TUCK_TOOLBAR=true;control_bar_box.style.display="none";controlbar_show.style.display="block"},VolumeUpOrOff:function(){if(Common.IS_IPHONE||Common.IS_IPAD){return}if(this.isvolumeup){this.OnVolumeOff();this.isvolumeup=false}else{this.OnVolumeUp();this.isvolumeup=true}},OnVolumeUp:function(){controlbar_volumeuporoff.className=this.basecss+"icon-volume-up";this.lesson.sound("on")},OnVolumeOff:function(){controlbar_volumeuporoff.className=this.basecss+"icon-volume-off";this.lesson.sound("off")},ToStop:function(){this.OnPause();this.ToFirstStep()},ToFirstStep:function(){this.lesson.steps[this.lesson.curStepIndex].onSeek(0);this.lesson.gotoStep(this.lesson.getCurStepIndex("first"))},ToLastStep:function(){this.lesson.gotoStep(this.lesson.getCurStepIndex("last"))},ToPreviousStep:function(){if(this.lesson.getCurStepIndex()!=this.lesson.getCurStepIndex("pre")){this.lesson.gotoStep(this.lesson.getCurStepIndex("pre"))}},ToNextStep:function(){this.lesson.gotoStep(this.lesson.getCurStepIndex("next"))},AdaptiveYesorNo:function(){if(this.lesson.isadaptive){controlbar_adaptive.className=this.basecss+"icon-original";this.lesson.isadaptive=false}else{controlbar_adaptive.className=this.basecss+"icon-scale";this.lesson.isadaptive=true}},UpdateProgressbarS:function(a){var b="visible";if(a!=0){b="visible"}else{b="hidden"}var g=(a*100)/this.lesson.steps[this.lesson.curStepIndex].totalTime;try{var c=null;if(document.styleSheets[0].rules!=undefined){c=document.styleSheets[0].rules}else{if(document.styleSheets[0].cssRules!=undefined){c=document.styleSheets[0].cssRules}}var k=controlbar_progressbarbox.offsetWidth;var h=k*(g/100);var f=c.length;for(var d=0;d<f;d++){if(c[d].selectorText==".progress-bar-indicator::before"){c[d].style.width=h+"px";c[d].style.visibility=b}if(c[d].selectorText==".progress-bar-indicator::after"){c[d].style.right=(k-h-5)+"px";c[d].style.visibility=b}}}catch(j){console.error("css rules undefined.")}cb_curindex.innerHTML=(this.lesson.curStepIndex+1)+" / "+this.lesson.steps.length;cb_curtime.innerHTML=FormatSeconds(a)+" / "+FormatSeconds(this.lesson.steps[this.lesson.curStepIndex].totalTime)}};var GetCss=function(b,a){return b.currentStyle?b.currentStyle[a]:document.defaultView.getComputedStyle(b,false)[a]};var FormatSeconds=function(d){var a=0;var c=0;var e=0;var b=0;if(d>1000){e=parseInt(d/1000);b=parseInt(d%1000);if(e>=60){c=parseInt(e/60);e=parseInt(e%60)}}else{b=d}if(c<10){c="0"+c}if(e<10){e="0"+e}return c+":"+e};var DoWorkByMode=function(a,b){switch(a){case"progressbar":case"playorpause":case"tofirststep":case"tolaststep":case"topreviousstep":case"tonextstep":case"tostop":case"progress-bar-indicator":if(b>Menu_Mode.lecture){return false}return true;break;default:return true}};controlbar_playorpause.onclick=function(){if(DoWorkByMode("playorpause",thisControlbar.curmode)){thisControlbar.PlayOrPause()}};controlbar_goback.onclick=function(){thisControlbar.GoBack()};controlbar_hide.onclick=function(){thisControlbar.HideMe()};controlbar_show.onclick=function(){};controlbar_volumeuporoff.onclick=function(){thisControlbar.VolumeUpOrOff()};controlbar_tofirststep.onclick=function(){if(DoWorkByMode("tofirststep",thisControlbar.curmode)){thisControlbar.ToFirstStep()}};controlbar_tolaststep.onclick=function(){if(DoWorkByMode("tolaststep",thisControlbar.curmode)){thisControlbar.ToLastStep()}};controlbar_topreviousstep.onclick=function(){if(DoWorkByMode("topreviousstep",thisControlbar.curmode)){thisControlbar.ToPreviousStep()}};controlbar_tonextstep.onclick=function(){if(DoWorkByMode("tonextstep",thisControlbar.curmode)){thisControlbar.ToNextStep()}};controlbar_adaptive.onclick=function(){thisControlbar.AdaptiveYesorNo();Resize()};controlbar_tostop.onclick=function(){if(DoWorkByMode("tostop",thisControlbar.curmode)){thisControlbar.ToStop()}};var clickX=0;var clickY=0;var proportion=0;var suspensionCurrBottom=0;var isSuspMoveing=false;var GetProgressBarProportion=function(a){var b=a/controlbar_progressbarbox.offsetWidth;if(b<=0){b=0}else{if(b>=1){b=1}}return b};var ProgressBarDownS=function(a){if(DoWorkByMode("progressbar",thisControlbar.curmode)){controlbar_progressbarbox.style.cursor="pointer";clickX=a==0?1:a;lesson.bAddEventMedia=false;lesson.flag_back_paused=true;thisControlbar.iscontroling=true;proportion=GetProgressBarProportion(a);var b=parseInt(this.lesson.steps[this.lesson.curStepIndex].totalTime*proportion);thisControlbar.UpdateProgressbarS(b);this.lesson.gotoPos(this.lesson.curStepIndex,b);this.lesson.steps[this.lesson.curStepIndex].onSeek(b)}};var ProgressBarUpS=function(a){if(clickX==0){return}controlbar_progressbarbox.style.cursor="default";var b=0;if(thisControlbar.iscontroling){b=parseInt(this.lesson.steps[this.lesson.curStepIndex].totalTime*proportion);thisControlbar.iscontroling=false;proportion=0}else{b=parseInt(this.lesson.steps[this.lesson.curStepIndex].totalTime*GetProgressBarProportion(a))}this.lesson.gotoPos(this.lesson.curStepIndex,b);lastMoveX=0;lesson.flag_back_paused=false;lesson.bAddEventMedia=false;clickX=0;moveToPause=false};var lastMoveX=0;var moveToPause=false;var ProgressBarMoveS=function(a){if(clickX==0){return}if(Math.abs(clickX-a)>1&&Math.abs(lastMoveX-a)>1){lastMoveX=a;proportion=GetProgressBarProportion(a);var b=parseInt(this.lesson.steps[this.lesson.curStepIndex].totalTime*proportion);thisControlbar.UpdateProgressbarS(b);this.lesson.gotoPos(this.lesson.curStepIndex,b);this.lesson.steps[this.lesson.curStepIndex].onSeek(b)}};var SuspensionDown=function(a){clickY=a;suspensionCurrBottom=parseInt(GetCss(controlbar_show,"bottom"))};var SuspensionUp=function(a){if(clickY>0){clickY=0}if(!isSuspMoveing&&a){thisControlbar.ShowMe()}isSuspMoveing=false};var SuspensionMove=function(e){if(clickY==0){return}var c=clickY-e;if(Math.abs(c)>1){isSuspMoveing=true;var b=suspensionCurrBottom+c;var d=parseInt(mainCanvas.style.height);var a=parseInt(GetCss(controlbar_show,"height"));if(b<=0||(b+a)>=d){return}controlbar_show.style.bottom=b+"px"}};controlbar_show.onmousedown=function(a){SuspensionDown(a.clientY)};controlbar_show.onmouseup=function(a){SuspensionUp(true)};window.onmouseup=function(a){ProgressBarUpS(lastMoveX);SuspensionUp(false)};window.onmousemove=function(a){SuspensionMove(a.clientY)};if(Common.VER_IOS==0){controlbar_progressbar.onmousedown=function(a){ProgressBarDownS(a.offsetX||a.layerX)};controlbar_progressbar.onmouseup=function(a){ProgressBarUpS(a.offsetX||a.layerX)};controlbar_progressbarbox.onmousemove=function(a){ProgressBarMoveS(a.offsetX||a.layerX)}}controlbar_progressbarbox.ontouchstart=function(a){ProgressBarDownS(a.layerX)};controlbar_progressbarbox.ontouchend=function(a){ProgressBarUpS(a.layerX)};controlbar_progressbarbox.ontouchmove=function(a){ProgressBarMoveS(a.layerX)};controlbar_show.ontouchstart=function(a){SuspensionDown(a.pageY)};controlbar_show.ontouchend=function(a){SuspensionUp(false)};controlbar_show.ontouchmove=function(a){SuspensionMove(a.pageY)};var Object=function(a){this.baseObject=a;if(a==undefined){return}this.layer=a.layer;if(a.img!=undefined){this.image=new Image();this.image.src=Common.DATA_PATH+a.img}this.point=new Point(a.x,a.y);this.width=a.w;this.height=a.h;this.startTime=a.startTime;this.totalTime=a.totalTime;this.currentMode=0;this.operationResult=new OperationResult();this.activatedInMode=a.showOrHide;if(this.activatedInMode==undefined){this.activatedInMode=new Array(true,true,true,true)}if(this.startTime==undefined){this.startTime=0}if(this.totalTime==undefined){this.totalTime=-1}this.activated=false;this.visible=false};Object.prototype={onCreate:function(){},onStart:function(){},onResume:function(){},setCurrentMode:function(a){this.currentMode=a;this.setVisibleByMode(a)},setVisibleByMode:function(a){this.visible=this.activatedInMode[this.currentMode]},setVisible:function(a){this.visible=a},getTotalTime:function(){return this.totalTime},isActivating:function(){return this.activated},pointInRect:function(e,c,g){var b=this.point.x,i=this.point.y,d=0,f=0;e.beginPath();if(this.image!=undefined&&this.width==undefined&&this.height==undefined){d=this.image.width;f=this.image.height}else{d=this.width;f=this.height}b=b*Common.CANVAS_SCALE+Common.CANVAS_SCALE_X;i=i*Common.CANVAS_SCALE+Common.CANVAS_SCALE_Y;d*=Common.CANVAS_SCALE;f*=Common.CANVAS_SCALE;e.rect(b,i,d,f);e.closePath();var a=e.isPointInPath(c.x,c.y);return a},pointInRectWithoutContext:function(i,b,a,c,h,f,e,g,d){var j=false;b=b*Common.CANVAS_SCALE+Common.CANVAS_SCALE_X;a=a*Common.CANVAS_SCALE+Common.CANVAS_SCALE_Y;c*=Common.CANVAS_SCALE;h*=Common.CANVAS_SCALE;f=f*Common.CANVAS_SCALE+Common.CANVAS_SCALE_X;e=e*Common.CANVAS_SCALE+Common.CANVAS_SCALE_Y;g*=Common.CANVAS_SCALE;d*=Common.CANVAS_SCALE;if(b>=f&&(b+c)<=(f+g)&&a>=e&&(a+h)<=(e+d)){if(i.x>=b&&i.x<=(b+c)&&i.y>=a&&i.y<=(a+h)){j=true}}return j},pointInLinkRect:function(d,b,h,g,f,c,e){d.beginPath();h=h*Common.CANVAS_SCALE+Common.CANVAS_SCALE_X;g=g*Common.CANVAS_SCALE+Common.CANVAS_SCALE_Y;f*=Common.CANVAS_SCALE;c*=Common.CANVAS_SCALE;d.rect(h,g,f,c);d.closePath();var a=d.isPointInPath(b.x,b.y);return a},getSelectedHyperLink:function(b,k,a){var h=null;if(this.hyperLinks!=undefined&&this.visible&&this.isInTime(a)){for(var f=0;f<this.hyperLinks.length;f++){var d=this.hyperLinks[f];for(var e=0;e<d.linkAreas.length;e++){var g=d.linkAreas[e];var c=this.pointInLinkRect(b,k,g.x,g.y,g.w,g.h,a);if(c==true){h=d;break}}}}return h},pointInImageRect:function(b,a,c){if(this.image==undefined||this.point==null){return false}return this.pointInRect(b,a,c)},isInTime:function(e,d,c){var a;var b;if(d!=undefined){a=d}else{a=this.startTime}if(c!=undefined){b=c}else{b=this.totalTime}if(a<=e&&(b==-1||e<=a+b)){return true}else{return false}},pause:function(){},play:function(){},paint:function(a,b){},drawImage:function(a,b){if(this.width==undefined||this.width==0){this.width=this.image.width}if(this.height==undefined||this.height==0){this.height=this.image.height}if(this.image!=undefined){if(!this.image.complete){this.image.onload=function(c){a.drawImage(this,this.point.x,this.point.y,this.width,this.height)}}else{a.drawImage(this.image,this.point.x,this.point.y,this.width,this.height)}}},clear:function(){this.operationResult.eventResult=EventResult.Ineffective;this.operationResult.actionType=Menu_Action.unknown},onmousedown:function(b,a,c){this.operationResult.eventResult=EventResult.Ineffective},onlongtouch:function(b,a,c){this.operationResult.eventResult=EventResult.Ineffective},ontouchclick:function(b,a,c){this.operationResult.eventResult=EventResult.Ineffective},onmousemove:function(b,a,c){if(this.visible&&this.isInTime(c)&&this.pointInRect(b,a,c)){return this.onMouseMoveIn(b,a,c)}else{this.onMouseMoveOut(b,a,c);return false}},onMouseMoveIn:function(b,a,c){return false},onMouseMoveOut:function(b,a,c){return false},onResize:function(){},getAnswer:function(){}};var Action=function(a){if(a==undefined){return}Object.apply(this,arguments);this.actionProperty=a;if(a.next!=undefined){this.operationResult.next=a.next}this.ctrlKey=false;this.shiftKey=false;this.altKey=false;this.anyKey=false;if(a.ctrlKey!=undefined){this.ctrlKey=a.ctrlKey}if(a.shiftKey!=undefined){this.shiftKey=a.shiftKey}if(a.altKey!=undefined){this.altKey=a.altKey}if(a.anyKey!=undefined){this.anyKey=a.anyKey}};Action.prototype=new Object();Action.prototype.constructor=Action;Action.prototype.onmousemove=function(b,a,c){if(this.visible){return Object.prototype.onmousemove.apply(this,arguments)}return false};Action.prototype.getClickRectResult=function(c,a,d,b){};Action.prototype.paint=function(a,b){};Action.prototype.clear=function(){Object.prototype.clear.call(this)};Action.prototype.setCurrentMode=function(a){this.setActivating(a);Object.prototype.setCurrentMode.call(this,a)};Action.prototype.setActivating=function(a){this.activated=this.activatedInMode[a]};Action.prototype.ontouchclick=function(b,a,c){if(this.isActivating()&&this.isInTime(c)){if(this.pointInRect(b,a,c)){this.operationResult.eventResult=EventResult.Correctly}else{this.operationResult.eventResult=EventResult.Incorrectly}}else{this.operationResult.eventResult=EventResult.Ineffective}};var ZoomPan=function(a){Object.apply(this,arguments);this.scale=a.scale;this.lastParam=a.lastParam};ZoomPan.prototype=new Object();ZoomPan.prototype.timeInZoomPan=function(a){if(a<this.startTime){return -1}else{if((this.totalTime<=-1)||(a<=(this.startTime+this.totalTime))){return 0}else{return 1}}};ZoomPan.prototype.freepaint=function(a){a.translate(Common.CANVAS_AFTER_SCALE_X,Common.CANVAS_AFTER_SCALE_Y);a.scale(Common.CANVAS_AFTER_SCALE,Common.CANVAS_AFTER_SCALE);Common.CANVAS_SCALE=Common.CANVAS_AFTER_SCALE;Common.CANVAS_SCALE_X=Common.CANVAS_AFTER_SCALE_X;Common.CANVAS_SCALE_Y=Common.CANVAS_AFTER_SCALE_Y;if(Common.FOCUS_EDIT_BOX!=null&&editsDiv.style.display!="none"){lesson.locateEditTag(Common.FOCUS_EDIT_BOX);Common.FOCUS_EDIT_BOX.onResize()}};ZoomPan.prototype.paint=function(c,e){var a=(this.scale-Common.CANVAS_AFTER_SCALE)/this.totalTime;var d=((this.point.x*this.scale)-Common.CANVAS_AFTER_SCALE_X)/this.totalTime;var b=((this.point.y*this.scale)-Common.CANVAS_AFTER_SCALE_Y)/this.totalTime;var f=e-this.startTime;Common.CANVAS_SCALE=(a*f)+Common.CANVAS_AFTER_SCALE;Common.CANVAS_SCALE_X=(d*f)+Common.CANVAS_AFTER_SCALE_X;Common.CANVAS_SCALE_Y=(b*f)+Common.CANVAS_AFTER_SCALE_Y;c.translate(Common.CANVAS_SCALE_X,Common.CANVAS_SCALE_Y);c.scale(Common.CANVAS_SCALE,Common.CANVAS_SCALE);if(Common.FOCUS_EDIT_BOX!=null&&editsDiv.style.display!="none"){lesson.locateEditTag(Common.FOCUS_EDIT_BOX);Common.FOCUS_EDIT_BOX.onResize()}};var MouseAction=function(c){Action.apply(this,arguments);this.mouseProperty=c;this.lastFlickerTime=0;this.strokeColor=c.strokeColor;this.sourceActionName=c.mouseActionName;var a=this.convertActionName(this.sourceActionName);var b=a.split(" ");this.buttonName=b[0];this.actionName=b[1]};MouseAction.prototype=new Action();MouseAction.prototype.constructor=MouseAction;MouseAction.prototype.paint=function(b,c){if(this.lastFlickerTime==0){this.lastFlickerTime=c}if(this.strokeColor!=undefined&&this.visible&&this.isInTime(c)){var a=false;if(this.currentMode!=3&&Common.FLICKER_TIME>0){if(c<this.lastFlickerTime+Common.FLICKER_TIME){}else{if(c>=this.lastFlickerTime+Common.FLICKER_TIME&&c<this.lastFlickerTime+2*Common.FLICKER_TIME){a=true}else{if(c>=this.lastFlickerTime+2*Common.FLICKER_TIME){this.lastFlickerTime=0}}}}if(!a){this.drawImage(b,c)}}};MouseAction.prototype.onMouseMoveIn=function(b,a,c){b.canvas.style.cursor="pointer";this.operationResult.eventResult=EventResult.Correctly;return true};MouseAction.prototype.clear=function(){this.lastFlickerTime=0;Action.prototype.clear.call(this)};MouseAction.prototype.setVisibleByMode=function(a){this.lastFlickerTime=0;if(!(a==2||a==3)&&this.activated){this.visible=true}else{this.visible=false}};MouseAction.prototype.onlongtouch=function(b,a,c){if(this.isActivating()&&this.isInTime(c)){if(this.pointInRect(b,a,c)&&(this.sourceActionName=="Right Down"||this.sourceActionName=="Right Up"||this.sourceActionName=="Right Click")){this.operationResult.eventResult=EventResult.Correctly}else{this.operationResult.eventResult=EventResult.Incorrectly}}else{this.operationResult.eventResult=EventResult.Ineffective}};MouseAction.prototype.onmousedown=function(c,a,f,g){var b=g.type;var d=this.convertButtonName(g.button);if(this.isActivating()&&this.isInTime(f)){if(this.buttonName==d){if(this.pointInRect(c,a,f)&&g.ctrlKey==this.ctrlKey&&g.altKey==this.altKey&&g.shiftKey==this.shiftKey){switch(b){case"mousedown":if(this.actionName=="Down"){this.operationResult.eventResult=EventResult.Correctly}else{this.operationResult.eventResult=EventResult.Incorrectly}break;case"mouseup":if(this.actionName=="Double"){this.operationResult.eventResult=EventResult.IncorrectlyButIneffective}else{if(this.actionName=="Up"){this.operationResult.eventResult=EventResult.Correctly}else{this.operationResult.eventResult=EventResult.Incorrectly}}break;case"dblclick":if(this.actionName=="Double"){this.operationResult.eventResult=EventResult.Correctly}else{this.operationResult.eventResult=EventResult.Incorrectly}break;default:"unknown";break}}else{this.operationResult.eventResult=EventResult.Incorrectly}}else{this.operationResult.eventResult=EventResult.Incorrectly}}else{this.operationResult.eventResult=EventResult.Ineffective}};MouseAction.prototype.convertButtonName=function(b){var a="";switch(b){case 0:a="Left";break;case 1:a="Middle";break;case 2:a="Right";break;default:break}return a};MouseAction.prototype.convertActionName=function(b){var a=undefined;switch(b){case"Left Click":a="Left Down";break;case"Middle Down":a="Left Down";break;case"Middle Up":a="Left Up";break;case"Middle Click":a="Left Down";break;case"Middle Double":a="Left Double";break;case"Right Click":a="Right Down";break;case"Right Double":a="Left Double";break;default:a=b;break}return a};var Note=function(a){Object.apply(this,arguments);this.hyperLinks=a.hyperLinks};Note.prototype=new Object();Note.prototype.constructor=Note;Note.prototype.paint=function(a,b){if(this.visible&&this.isInTime(b)){this.drawImage(a,b)}};Note.prototype.onmousedown=function(b,a,c,f){var d=this.getSelectedHyperLink(b,a,c);if(f.button==0&&f.type!="mouseup"&&d!=null&&b.canvas.style.cursor=="pointer"){if(d.linkUrl.indexOf("mailto:")>-1){window.location.href=d.linkUrl}else{window.open(d.linkUrl)}this.operationResult.eventResult=EventResult.CorrectlyButIneffective}else{this.operationResult.eventResult=EventResult.Ineffective}};Note.prototype.ontouchclick=function(b,a,c){var d=this.getSelectedHyperLink(b,a,c);if(d!=null){if(d.linkUrl.indexOf("mailto:")>-1){window.location.href=d.linkUrl}else{window.open(d.linkUrl)}this.operationResult.eventResult=EventResult.CorrectlyButIneffective}else{this.operationResult.eventResult=EventResult.Ineffective}};Note.prototype.onMouseMoveIn=function(b,a,c){var d=this.getSelectedHyperLink(b,a,c);if(d!=null){b.canvas.style.cursor="pointer"}return true};var PromptBox=function(a){Object.apply(this,arguments);this.promptBoxProperty=a;this.imgInfo=new Image();this.imgInfo.src=Common.DATA_PATH+a.imgInfo;this.pointInfo=new Point(a.xInfo,a.yInfo);this.isInfo=false;this.hyperLinks=a.hyperLinks};PromptBox.prototype=new Object();PromptBox.prototype.constructor=PromptBox;PromptBox.prototype.paint=function(a,b){if(this.visible&&this.isInTime(b)){if(this.image!==undefined){if(!this.image.complete){this.image.onload=function(c){a.drawImage(this,this.point.x,this.point.y,this.width,this.height)}}else{if(this.isInfo==false){a.drawImage(this.image,this.point.x,this.point.y,this.width,this.height)}else{a.drawImage(this.imgInfo,this.pointInfo.x,this.pointInfo.y)}}}}};PromptBox.prototype.onMouseMoveIn=function(b,a,c){var d=this.getSelectedHyperLink(b,a,c);if(this.isInfo==false||this.isInfo==true&&d!=null){b.canvas.style.cursor="pointer"}this.isInfo=true;return true};PromptBox.prototype.onMouseMoveOut=function(b,a,c){if(this.visible&&this.isInTime(c)&&!this.touchInRect(b,a,c)){this.isInfo=false}else{if(this.visible&&this.isInTime(c)&&this.touchInRect(b,a,c)){var d=this.getSelectedHyperLink(b,a,c);if(this.isInfo==false||this.isInfo==true&&d!=null){b.canvas.style.cursor="pointer"}}}};PromptBox.prototype.onmousedown=function(b,a,c,f){if(f.button==0&&this.visible&&this.isInTime(c)&&this.touchInRect(b,a,c)){if(this.isInfo==true){var d=this.getSelectedHyperLink(b,a,c);if(d!=null&&b.canvas.style.cursor=="pointer"&&f.type!="mouseup"){if(d.linkUrl.indexOf("mailto:")>-1){window.location.href=d.linkUrl}else{window.open(d.linkUrl)}this.operationResult.eventResult=EventResult.CorrectlyButIneffective}else{this.operationResult.eventResult=EventResult.Ineffective}}}else{this.operationResult.eventResult=EventResult.Ineffective}};PromptBox.prototype.ontouchclick=function(b,a,c){if(this.visible&&this.isInTime(c)&&this.touchInRect(b,a,c)){var d=this.getSelectedHyperLink(b,a,c);if(this.isInfo==true&&d!=null){if(d.linkUrl.indexOf("mailto:")>-1){window.location.href=d.linkUrl}else{window.open(d.linkUrl)}}this.isInfo=!this.isInfo;this.operationResult.eventResult=EventResult.CorrectlyButIneffective}else{this.operationResult.eventResult=EventResult.Ineffective}};PromptBox.prototype.touchInRect=function(d,b,f){var a=this.point.x,g=this.point.y,c=0,e=0;d.beginPath();if(this.image!=undefined&&!this.isInfo){c=this.image.width;e=this.image.height}else{if(this.imgInfo.src!=undefined&&this.isInfo){c=this.imgInfo.width;e=this.imgInfo.height}else{c=this.width;e=this.height}}a=a*Common.CANVAS_SCALE+Common.CANVAS_SCALE_X;g=g*Common.CANVAS_SCALE+Common.CANVAS_SCALE_Y;c*=Common.CANVAS_SCALE;e*=Common.CANVAS_SCALE;d.rect(a,g,c,e);return d.isPointInPath(b.x,b.y)},PromptBox.prototype.clear=function(){Object.prototype.clear.call(this);this.isInfo=false};var EditBox=function(a){Action.apply(this,arguments);this.editBoxProperty=a;this.fontRatio=0.7;this.strokeColor=a.strokeColor;this.contentType=a.contentType;this.contents=a.contents;this.isEnglish=false;if(a.isEnglish!=undefined){this.isEnglish=a.isEnglish}};EditBox.prototype=new Action();EditBox.prototype.constructor=EditBox;EditBox.prototype.paint=function(a,b){if(this.visible&&this.isInTime(b)){this.drawImage(a,b)}};EditBox.prototype.onmousedown=function(b,a,c){if(this.visible&&this.isInTime(c)){if(this.pointInRect(b,a)){this.operationResult.eventResult=EventResult.PointInEditBox}else{this.operationResult.eventResult=EventResult.Ineffective}}else{this.operationResult.eventResult=EventResult.Ineffective}};EditBox.prototype.onMouseMoveIn=function(b,a,c){b.canvas.style.cursor="text";return true};EditBox.prototype.clear=function(){Action.prototype.clear.call(this);Common.FOCUS_EDIT_BOX=null;if(editsDiv.style.display!="none"){editsDiv.style.display="none"}};EditBox.prototype.onResize=function(){editBox.style.fontSize=editBox.clientHeight*this.fontRatio};EditBox.prototype.ontouchclick=function(b,a,c){this.onmousedown(b,a,c)};EditBox.prototype.onInput=function(c,b){if(this.anyKey){this.operationResult.eventResult=EventResult.Correctly}else{if(this.isEnglish&&this.visible&&this.isInTime(b)){var a=editBox.value;if(this.contents==undefined||this.contents.length==0||a.length<=0){editBox.value="";this.operationResult.eventResult=EventResult.Incorrectly}else{switch(this.contentType){case 0:this.isEnglishNormalMultiAnswers(a);break;case 1:this.isEnglishIgnoreCaseAnswer(a);break;case 2:this.isEnglishTextCount(a);break;case 3:this.isEnglishWildcard(a);break;default:break}}}}};EditBox.prototype.isEnglishNormalMultiAnswers=function(a){var d=this.contents;for(var c=0;c<d.length;c++){var b=d[c].text.substr(0,a.length);if(a==b){if(a.length==d[c].text.length){this.operationResult.eventResult=EventResult.Correctly;this.operationResult.next=d[c].next}else{this.operationResult.eventResult=EventResult.CorrectlyButIneffective}return}}editBox.value="";this.operationResult.eventResult=EventResult.Incorrectly};EditBox.prototype.isEnglishIgnoreCaseAnswer=function(a){var c=this.contents[0];var b=c.text.substr(0,a.length);if(a.toLowerCase()==b.toLowerCase()){if(a.length==c.text.length){this.operationResult.eventResult=EventResult.Correctly;this.operationResult.next=c.next}else{this.operationResult.eventResult=EventResult.CorrectlyButIneffective}return}editBox.value="";this.operationResult.eventResult=EventResult.Incorrectly};EditBox.prototype.isEnglishTextCount=function(a){var b=this.contents[0];if(a.length>=b.from&&a.length<=b.to){this.operationResult.eventResult=EventResult.Correctly;this.operationResult.next=b.next}else{if(a.length>b.to){this.operationResult.eventResult=EventResult.Incorrectly}else{this.operationResult.eventResult=EventResult.CorrectlyButIneffective}}};EditBox.prototype.isEnglishWildcard=function(a){var b=a.length;var d=this.contents[0];var c=d.text.substr(0,a.length);if(this.equalsWithWildcard(c,a,"*")){if(a.length==d.text.length){this.operationResult.eventResult=EventResult.Correctly;this.operationResult.next=d.next}else{this.operationResult.eventResult=EventResult.CorrectlyButIneffective}return}editBox.value="";this.operationResult.eventResult=EventResult.Incorrectly};EditBox.prototype.equalsWithWildcard=function(e,b,a){var d="";var g=0;for(var c=0;c<e.length;c++){var f=e.indexOf(e[c]);if(e[c]==a){d=d+b.substring(g,c)+a;g=c+1}}d=d+b.substring(g,b.length);if(d==e){return true}else{return false}};EditBox.prototype.onEnterKeyDown=function(c,b){if(this.anyKey){this.operationResult.eventResult=EventResult.Correctly}else{if(!this.isEnglish&&this.visible&&this.isInTime(b)){var a=editBox.value;if(this.contents==undefined||this.contents.length==0||a.length<=0){editBox.value="";this.operationResult.eventResult=EventResult.Incorrectly}else{switch(this.contentType){case 0:this.notEnglishNormalMultiAnswers(a);break;case 1:this.notEnglishIgnoreCaseAnswer(a);break;case 2:this.notEnglishTextCount(a);break;case 3:this.notEnglishWildcard(a);break;default:break}}}}};EditBox.prototype.notEnglishNormalMultiAnswers=function(a){var c=this.contents;for(var b=0;b<c.length;b++){if(a==c[b].text){this.operationResult.eventResult=EventResult.Correctly;this.operationResult.next=c[b].next;return}}editBox.value="";this.operationResult.eventResult=EventResult.Incorrectly};EditBox.prototype.notEnglishIgnoreCaseAnswer=function(a){var b=this.contents[0];if(a.toLowerCase()==b.text.toLowerCase()){this.operationResult.eventResult=EventResult.Correctly;this.operationResult.next=b.next}else{editBox.value="";this.operationResult.eventResult=EventResult.Incorrectly}};EditBox.prototype.notEnglishTextCount=function(a){var b=this.contents[0];if(a.length>=b.from&&a.length<=b.to){this.operationResult.eventResult=EventResult.Correctly;this.operationResult.next=b.next}else{editBox.value="";this.operationResult.eventResult=EventResult.Incorrectly}};EditBox.prototype.notEnglishWildcard=function(a){var d=this.contents[0];var c=d.text;if(c.length!=a.length){editBox.value="";this.operationResult.eventResult=EventResult.Incorrectly;return}else{for(var b=0;b<c.length;b++){if(c.charAt(b)=="*"){continue}else{if(c.charAt(b)!=a.charAt(b)){this.operationResult.eventResult=EventResult.Incorrectly;return}}}this.operationResult.eventResult=EventResult.Correctly;this.operationResult.next=d.next}};EditBox.prototype.getAnswer=function(){var a="";switch(this.contentType){case 0:if(this.contents.length>0){a=lang_data.msg.inputTextMultiAnswers;for(var b=0;b<this.contents.length;b++){a=a+"\n"+this.contents[b].text;if(b!=this.contents.length-1){a=a+"\n"+lang_data.msg.inputTextOr}}}break;case 1:if(this.contents.length>0){a=lang_data.msg.inputTextIgnoreCase+"\n"+this.contents[0].text}break;case 2:if(this.contents.length>0){a=lang_data.msg.inputTextTextCount+"\n";if(this.contents[0].from==this.contents[0].to){a=a+this.contents[0].from}else{a=a+this.contents[0].from+lang_data.msg.inputTextFrom+this.contents[0].to+lang_data.msg.inputTextTo}}break;case 3:if(this.contents.length>0){a=lang_data.msg.inputTextWildcard+"\n"+this.contents[0].text}break;default:break}return a};var MouseRoute=function(b,a,c){Object.apply(this,arguments);this.iStepRoute=c;this.mouseRouteArray=b;if(a!=undefined){this.image=new Image();this.image.src=Common.DATA_PATH+a}};MouseRoute.prototype=new Object();MouseRoute.prototype.constructor=MouseRoute;MouseRoute.prototype.paint=function(c,d){if(this.iStepRoute&&this.currentMode>0){return}for(var b=0;b<this.mouseRouteArray.length;b++){var a=this.mouseRouteArray[b];if(this.isInTime(d,a.startTime,a.totalTime)){if(this.image!==undefined){if(!this.image.complete){this.image.onload=function(f){c.drawImage(this,a.sx,a.sy,a.sw,a.sh,a.x,a.y,a.sw,a.sh)}}else{c.drawImage(this.image,a.sx,a.sy,a.sw,a.sh,a.x,a.y,a.sw,a.sh)}}break}}};var KeyAction=function(a){Action.apply(this,arguments);this.grey="#464547";this.key_stroke_ratio=0.1;this.font_size=30;this.keyCodes=a.keyCodes;this.keyName=this.getWholeKeyName(a.keyCodes,a.keyName)};KeyAction.prototype=new Action();KeyAction.prototype.constructor=KeyAction;KeyAction.prototype.paint=function(a,b){if(this.visible&&this.isInTime(b)&&(Common.CURRENT_EXPLORER==ExplorerInfo.METRO_IE||Common.CURRENT_EXPLORER==ExplorerInfo.IOS)||Common.CURRENT_EXPLORER==ExplorerInfo.ANDROID){a.save();a.beginPath();var c=a.createLinearGradient(this.point.x,this.point.y,this.point.x+this.width,this.point.y+this.height);c.addColorStop(0,"#ffffff");c.addColorStop(0.49,"#545454");c.addColorStop(0.5,"#5e5e5e");c.addColorStop(1,"#000000");a.lineJoin="round";a.lineWidth=40/Common.SCALE_RATIO;a.fillStyle=c;a.strokeStyle=c;a.strokeRect(this.point.x,this.point.y,this.width,this.height);a.fillRect(this.point.x,this.point.y,this.width,this.height);a.closePath();a.beginPath();var d=a.createLinearGradient(this.point.x+this.width*this.key_stroke_ratio,this.point.y,this.point.x+this.width*(1-this.key_stroke_ratio),this.point.y);d.addColorStop(0,"#6e6e6e");d.addColorStop(1,"#b5b5b5");a.lineJoin="round";a.lineWidth=30/Common.SCALE_RATIO;a.fillStyle=d;a.strokeStyle=d;a.strokeRect(this.point.x+this.width*this.key_stroke_ratio,this.point.y+this.height*this.key_stroke_ratio,this.width*(1-2*this.key_stroke_ratio),this.height*(1-2*this.key_stroke_ratio));a.fillRect(this.point.x+this.width*this.key_stroke_ratio,this.point.y+this.height*this.key_stroke_ratio,this.width*(1-2*this.key_stroke_ratio),this.height*(1-2*this.key_stroke_ratio));a.closePath();a.font=this.font_size/Common.SCALE_RATIO+"px Calibri";a.textAlign="center";a.fillStyle="black";a.fillText(this.keyName,this.point.x+this.width/2,this.point.y+this.height/2+this.font_size/3);a.restore()}};KeyAction.prototype.onkeyup=function(b,a){if(this.visible&&this.isInTime(a)){if(this.anyKey||(this.equalsByKeyCode(this.keyCodes,b.keyCode)&&b.keyCode==17&&this.shiftKey==b.shiftKey&&this.altKey==b.altKey)||(this.equalsByKeyCode(this.keyCodes,b.keyCode)&&b.keyCode==16&&this.ctrlKey==b.ctrlKey&&this.altKey==b.altKey)||(this.equalsByKeyCode(this.keyCodes,b.keyCode)&&b.keyCode==18&&this.ctrlKey==b.ctrlKey&&this.shiftKey==b.shiftKey)){this.operationResult.eventResult=EventResult.Correctly}else{if(this.equalsByKeyCode(this.keyCodes,b.keyCode)&&this.ctrlKey==b.ctrlKey&&this.shiftKey==b.shiftKey&&this.altKey==b.altKey){this.operationResult.eventResult=EventResult.Correctly}else{this.operationResult.eventResult=EventResult.Incorrectly}}}else{this.operationResult.eventResult=EventResult.Ineffective}};KeyAction.prototype.equalsByKeyCode=function(c,d){var b=false;for(var a=0;a<c.length;a++){srcKeyCode=c[a];if(srcKeyCode==d){b=true;break}}return b};KeyAction.prototype.getWholeKeyName=function(c,f){var e=f;var b=false;var a=false;var g=false;for(var d=0;d<c.length;d++){keyCode=c[d];if(keyCode==16){b=true}if(keyCode==18){a=true}if(keyCode==17){g=true}}if(this.shiftKey&&!b){e="Shift + "+e}if(this.altKey&&!a){e="Alt + "+e}if(this.ctrlKey&&!g){e="Ctrl + "+e}return e};KeyAction.prototype.ontouchclick=function(b,a,c){if(this.visible&&this.isInTime(c)&&(Common.CURRENT_EXPLORER==ExplorerInfo.METRO_IE||Common.CURRENT_EXPLORER==ExplorerInfo.IOS||Common.CURRENT_EXPLORER==ExplorerInfo.ANDROID)){Action.prototype.ontouchclick.call(this,b,a,c)}else{this.operationResult.eventResult=EventResult.Ineffective}};var Button=function(a){Action.apply(this,arguments)};Button.prototype=new Action();Button.prototype.constructor=Button;Button.prototype.paint=function(a,b){if(this.visible&&this.isInTime(b)){this.drawImage(a,b)}};Button.prototype.onMouseMoveIn=function(b,a,c){b.canvas.style.cursor="pointer"};Button.prototype.onmousedown=function(c,a,d,b){if(this.isActivating()&&this.isInTime(d)){if(this.pointInRect(c,a,d)){this.operationResult.eventResult=EventResult.Correctly}else{this.operationResult.eventResult=EventResult.Incorrectly}}else{this.operationResult.eventResult=EventResult.Ineffective}};var Spotlights=function(a){Object.apply(this,arguments);this.width=Common.LESSON_WIDTH;this.height=Common.LESSON_HEIGHT;this.point=new Point(0,0);this.entrance=a.entrance;this.exit=a.exit;this.eachEntrance=1/a.entrance;this.eachExit=1/a.exit;this.curAlpha=0;this.exitStartime=this.totalTime-a.exit};Spotlights.prototype=new Object();Spotlights.prototype.paint=function(a,b){if(this.visible&&this.isInTime(b)){var c=b-this.startTime;if(c<=this.entrance){this.curAlpha=this.eachEntrance*c}else{this.curAlpha=1}if(c>=this.exitStartime&&c<=this.totalTime&&this.exit>0){this.curAlpha=1-(this.eachExit*(c-this.exitStartime))}a.globalAlpha=this.curAlpha;this.drawImage(a,b)}a.globalAlpha=1};var VideObj=function(a){Object.apply(this,arguments);this.seekTime=0;this.isMp3=false;this.isMediaReady=true;this.videoID=Common.VIDEO_OBJ_ID++;this.videoSrc=Common.DATA_PATH+a.src;this.prms1=null;this.prms2=null;this.useAudio=this.useType();this.currAudio=null;this.currVideo=null};VideObj.prototype=new Object();VideObj.prototype.constructor=VideObj;VideObj.prototype.getMedia=function(){if(this.useAudio){return this.currAudio}else{return this.currVideo}};VideObj.prototype.removeEvent=function(){};VideObj.prototype.addEvent=function(){var a=this;if(a.useAudio){a.currAudio.onloadstart=function(){if(a.isLoaded()){a.isMediaReady=false}};a.currAudio.ondurationchange=function(){if(a.isLoaded()){if(a.checkMediaTime()){a.seek(a.startTime+a.seekTime)}}};a.currAudio.ontimeupdate=function(){}}else{a.currVideo.oncanplay=function(){a.isMediaReady=true};a.currVideo.onloadstart=function(){if(a.isLoaded()){a.isMediaReady=false}};a.currVideo.ondurationchange=function(){if(a.isLoaded()){if(a.checkMediaTime()){a.seek(a.startTime+a.seekTime)}}};a.currVideo.ontimeupdate=function(){}}};VideObj.prototype.checkMediaTime=function(){if(this.isLoaded()&&this.isInTime(lesson.durationStep)){return(lesson.durationStep-(this.startTime+this.getTime()))>100}else{return false}};VideObj.prototype.isReady=function(a){if(this.visible&&this.isInTime(a)){if(this.isLoaded()){if(this.isMediaReady){if(this.useAudio){if(this.currAudio.readyState!=4||this.currVideo.readyState!=4){return false}else{return true}}else{if(this.currVideo.readyState!=4){return false}else{return true}}}else{return false}}else{if(this.useAudio){this.prmsMedia()}this.loadMedia();this.isMediaReady=false;return false}}else{return true}};VideObj.prototype.prmsMedia=function(){var a=this;if(a.prms1==null&&a.prms2==null){a.prms1=new Promise(function(c,b){a.currVideo.addEventListener("canplay",function(){c()});a.currVideo.addEventListener("error",function(){b()})});a.prms2=new Promise(function(c,b){a.currAudio.addEventListener("canplay",function(){c()});a.currAudio.addEventListener("error",function(){b()})});Promise.all([a.prms1,a.prms2]).then(function(){a.isMediaReady=true},function(){a.isMediaReady=true})}};VideObj.prototype.loadMedia=function(){if(this.useAudio){this.currVideo.src=this.videoSrc;this.currVideo.load();this.currAudio.src=this.videoSrc;this.currAudio.load()}else{this.currVideo.src=this.videoSrc;this.currVideo.load()}};VideObj.prototype.isLoaded=function(){try{if(this.useAudio){return this.currVideo.src.indexOf(Common.getFileName(this.videoSrc))!=-1&&this.currAudio.src.indexOf(Common.getFileName(this.videoSrc))!=-1}else{return this.currVideo.src.indexOf(Common.getFileName(this.videoSrc))!=-1}}catch(a){}};VideObj.prototype.getTime=function(){try{if(this.useAudio){return this.currAudio.currentTime*1000}else{return this.currVideo.currentTime*1000}}catch(a){}};VideObj.prototype.paint=function(a,b){if(this.visible&&this.isInTime(b)||!this.getMedia().ended){if(this.useAudio){this.currAudio.muted=lesson.muted;if(!lesson.flag_Paused&&!this.currAudio.ended){if(!thisControlbar.iscontroling){this.currAudio.play()}else{this.currAudio.pause()}}if(!this.isMp3){this.currVideo.currentTime=this.currAudio.currentTime}}else{this.currVideo.muted=lesson.muted;if(!lesson.flag_Paused&&!this.currVideo.ended){if(!thisControlbar.iscontroling){if(lesson.flag_Paused){this.currVideo.play()}}else{this.currVideo.pause()}}}if(!this.isMp3){a.drawImage(this.currVideo,this.point.x,this.point.y,this.width,this.height)}}else{if(this.isLoaded()){this.deleteVideObjTag()}}};VideObj.prototype.deleteVideObjTag=function(){this.removeEvent();ReleaseMedia(this.videoID);this.isMediaReady=true;this.prms1=null;this.prms2=null};VideObj.prototype.seek=function(d){var e=this;var b=d-e.startTime;if(b>=0&&b<=e.totalTime){e.seekTime=b;var a=function(){SeekMedia(e.videoID,e.seekTime/1000)};var c=function(){a();if(this.useAudio){e.currAudio.onloadedmetadata=null}else{e.currVideo.onloadedmetadata=null}};if(!e.isMediaReady&&Common.CURRENT_EXPLORER==ExplorerInfo.DESKTOP_IE){if(this.useAudio){e.currAudio.onloadedmetadata=function(){c()}}else{e.currVideo.onloadedmetadata=function(){c()}}}else{a()}}};VideObj.prototype.pause=function(){var a=this.getMedia();if(a!=null){if(this.isLoaded()&&!a.ended){a.pause()}}};VideObj.prototype.play=function(){var a=this.getMedia();if(a!=null){if(this.isLoaded()&&!a.ended){a.muted=lesson.muted;a.play()}}};VideObj.prototype.clear=function(){this.deleteVideObjTag()};VideObj.prototype.useType=function(){if(this.videoSrc.substring(this.videoSrc.lastIndexOf("."),this.videoSrc.length)==".mp3"){this.isMp3=true}else{this.isMp3=false}if(Common.VER_IOS>0){return true}else{return false}};VideObj.prototype.setCurrentMode=function(a){Object.prototype.setCurrentMode.call(this,a);this.useAudio=this.useType();this.currVideo=mediaPool[this.videoID].video;this.currAudio=mediaPool[this.videoID].audio;this.addEvent()};var Step=function(a,c,k,j,l,g,h,b){this.zoomPans=[];this.objects=[];this.imageBK=new Array();if(c!=undefined){for(var f=0;f<c.length;f++){var e=new Image();e.src=Common.DATA_PATH+c[f].src;var d=new Array();d.img=e;d.imgname=c[f].src;d.imgwidth=c[f].w==undefined?Common.LESSON_WIDTH:c[f].w;d.imgheight=c[f].h==undefined?Common.LESSON_HEIGHT:c[f].h;d.point=new Point(c[f].x==undefined?0:c[f].x,c[f].y==undefined?0:c[f].y);d.time=c[f].totalTime;this.imageBK.push(d)}}this.totalTime=a;this.currentMode=-1;this.currentTime;this.pro=l;this.next=g;this.num=h;this.activeEditBox=null;this.bInExam=false;this.bScore=b;this.examinationTryNumb=0;this.mockExaminationTryNumb=0;this.bCorrect=false;this.bTimeout=false;this.bPrompt=false;this.actionResult=undefined};Step.prototype={init:function(a){this.bInExam=false;this.examinationTryNumb=0;this.bCorrect=false;this.bTimeout=false;this.bPrompt=false;this.currentMode=a;this.actionResult=undefined;this.activeEditBox=null;this.onResume();this.clear()},onSeek:function(b){var c=this.objects;for(var a=0;a<c.length;a++){if(c[a].seek!=undefined){c[a].seek(b)}}},onResume:function(){this.mockExaminationTryNumb=0;this.actionResult=undefined;this.activeEditBox=null;var c=this.objects;for(var a=0;a<c.length;a++){c[a].setCurrentMode(this.currentMode)}var b=this.zoomPans;for(var a=0;a<b.length;a++){b[a].setCurrentMode(this.currentMode)}},getEventResult:function(){return this.actionResult},setEventResult:function(a){this.actionResult=a},paintBK:function(c,e){if(this.imageBK!==undefined){var f=0;for(var b=0;b<this.imageBK.length;b++){if(e>f&&e<=f+this.imageBK[b].time||e==0&&f==0&&b==0||(b+1)==this.imageBK.length){var a=this.imageBK[b].img;var d=this.imageBK[b].point;if(!a.complete){a.onload=function(g){c.drawImage(this,d.x,d.y,this.imageBK[b].imgwidth,this.imageBK[b].imgheight)}}else{c.drawImage(a,d.x,d.y,this.imageBK[b].imgwidth,this.imageBK[b].imgheight)}break}f+=this.imageBK[b].time}}},haveEffectAction:function(){var a=false;for(var b=0;b<this.objects.length;b++){var c=this.objects[b];if(c.activated){a=true;break}}return a},pause:function(){for(var a=0;a<this.objects.length;a++){this.objects[a].pause()}},play:function(){for(var a=0;a<this.objects.length;a++){this.objects[a].play()}},paintObjects:function(c,f,g){if(this.currentMode>0&&f>=this.totalTime){this.currentTime=this.totalTime}else{this.currentTime=f}c.save();Common.CANVAS_SCALE=1;Common.CANVAS_SCALE_X=0;Common.CANVAS_SCALE_Y=0;Common.CANVAS_AFTER_SCALE=1;Common.CANVAS_AFTER_SCALE_X=0;Common.CANVAS_AFTER_SCALE_Y=0;if(this.zoomPans.length>0){var d=-1;for(var b=0;b<this.zoomPans.length;b++){if(!this.zoomPans[b].activatedInMode[g]){continue}var e=this.zoomPans[b].timeInZoomPan(this.currentTime);if(e==1){Common.CANVAS_AFTER_SCALE=this.zoomPans[b].scale;Common.CANVAS_AFTER_SCALE_X=this.zoomPans[b].point.x*this.zoomPans[b].scale;Common.CANVAS_AFTER_SCALE_Y=this.zoomPans[b].point.y*this.zoomPans[b].scale}else{if(e==0){d=b;break}else{if(e==-1){continue}}}}if(d>=0){this.zoomPans[d].paint(c,this.currentTime)}else{this.zoomPans[0].freepaint(c)}}this.paintBK(c,this.currentTime);var a=Common.getTimeNow();for(var b=0;b<this.objects.length;b++){if(this.objects[b].constructor==MouseAction){this.objects[b].paint(c,f)}else{this.objects[b].paint(c,this.currentTime)}}c.restore()},pauseReadyObject:function(){for(var a=0;a<this.objects.length;a++){if(this.objects[a].constructor==VideObj&&this.objects[a].isMediaReady){this.objects[a].pause()}}},playReadyObject:function(){for(var a=0;a<this.objects.length;a++){if(this.objects[a].constructor==VideObj&&this.objects[a].isMediaReady){this.objects[a].play()}}},mediaReady:function(b){var c=this.objects;for(var a=0;a<c.length;a++){if(c[a].isReady!=undefined){if(!c[a].isReady(b)){return false}}}return true},checkMediaTime:function(){var b=this.objects;for(var a=0;a<b.length;a++){if(this.objects[a].constructor!=VideObj){continue}if(b[a].checkMediaTime()){return false}}return true},paint:function(b,c,d){var a=this.checkMediaTime();if(!this.mediaReady(c)||!a){if(a){this.pauseReadyObject();canvasLoader.setState(Menu_LoadFlag.loading)}lesson.flag_back_paused=true;lesson.time_Last=Common.getTimeNow();return}else{canvasLoader.setState(Menu_LoadFlag.ok);lesson.clearScreen();if(thisControlbar.iscontroling){this.paintObjects(b,c,d);return}if(!lesson.flag_Paused){this.playReadyObject()}lesson.flag_back_paused=false}this.paintObjects(b,c,d)},clear:function(){for(var a=0;a<this.objects.length;a++){this.objects[a].clear()}},onmousedown:function(d,a,g,h){var f=undefined;for(var c=this.objects.length-1;c>=0;c--){var b=this.objects[c];if(h!=0||(h==0&&b.hyperLinks!=undefined&&b.hyperLinks!=null)){b.onmousedown(d,a,this.currentTime,g)}if(b.operationResult.eventResult==EventResult.Correctly){if(b.operationResult.next==undefined){b.operationResult.next=this.next}f=b.operationResult;break}else{if(b.operationResult.eventResult==EventResult.CorrectlyButIneffective||b.operationResult.eventResult==EventResult.IncorrectlyButIneffective){f=b.operationResult;break}else{if(b.operationResult.eventResult==EventResult.PointInEditBox){f=b.operationResult;this.activeEditBox=b;break}}}}if(f==undefined){f=new OperationResult();f.eventResult=EventResult.Incorrectly}this.actionResult=f},onmousemove:function(c,a,e){c.canvas.style.cursor="default";for(var b=this.objects.length-1;b>=0;b--){var d=this.objects[b];if(e!=0||(e==0&&(d.constructor==Note||d.constructor==PromptBox))){if(d.onmousemove(c,a,this.currentTime)){return}}}},onResize:function(c,a){for(var b=0;b<this.objects.length;b++){var d=this.objects[b];if(d.constructor===EditBox){d.onResize()}}},disposeActiveEditBox:function(){this.activeEditBox=null},ontouchclick:function(d,a,g){var f=0;var e=undefined;for(var c=this.objects.length-1;c>=0;c--){var b=this.objects[c];if(g!=0||(g==0&&b.hyperLinks!=undefined&&b.hyperLinks!=null)){b.ontouchclick(d,a,this.currentTime)}if(b.operationResult.eventResult==EventResult.Correctly){if(b.operationResult.next==undefined){b.operationResult.next=this.next}e=b.operationResult;break}else{if(b.operationResult.eventResult==EventResult.CorrectlyButIneffective||b.operationResult.eventResult==EventResult.IncorrectlyButIneffective){e=b.operationResult;break}else{if(b.operationResult.eventResult==EventResult.PointInEditBox){e=b.operationResult;this.activeEditBox=b;break}}}}if(e==undefined){e=new OperationResult();e.eventResult=EventResult.Incorrectly}this.actionResult=e},onInput:function(a){if(this.activeEditBox!=null){this.activeEditBox.onInput(a,this.currentTime);if(this.activeEditBox.operationResult.eventResult==EventResult.Correctly){if(this.activeEditBox.operationResult.next==undefined){this.activeEditBox.operationResult.next=this.next}}this.actionResult=this.activeEditBox.operationResult}},onEnterKeyDown:function(a){if(this.activeEditBox!=null){this.activeEditBox.onEnterKeyDown(a,this.currentTime);if(this.activeEditBox.operationResult.eventResult==EventResult.Correctly){if(this.activeEditBox.operationResult.next==undefined){this.activeEditBox.operationResult.next=this.next}}this.actionResult=this.activeEditBox.operationResult}},InitailizeEditBox:function(){for(var a=0;a<this.objects.length;a++){var b=this.objects[a];if(b.constructor===EditBox&&b.activated&&b.isInTime(b.startTime)){this.activeEditBox=b;break}}},onKeyUp:function(b){var d=undefined;for(var a=0;a<this.objects.length;a++){var c=this.objects[a];if(c.constructor===KeyAction){c.onkeyup(b,this.currentTime);if(c.operationResult.eventResult==EventResult.Correctly){if(c.operationResult.next==undefined){c.operationResult.next=this.next}d=c.operationResult;break}}}if(d==undefined){d=new OperationResult();d.eventResult=EventResult.Incorrectly}this.actionResult=d},isAudioStep:function(){if(Common.getAudioElement()==null){return false}for(var a=0;a<this.objects.length;a++){var b=this.objects[a];if(b.constructor==AudiObj){if(b.isEffective()){return true}}}return false},addMockExamTryNumb:function(){if(this.haveEffectAction()){this.mockExaminationTryNumb++}},showAnswerTips:function(){var c=this.objects;for(var b=0;b<c.length;b++){var a=c[b];if(a.constructor===MouseAction&&a.isActivating()){a.setVisible(true)}else{if(a.constructor===PromptBox||a.constructor===Note){a.setVisible(true)}}}},showAnswer:function(b){this.bPrompt=true;var a="";if(b==Menu_Action.keyAction){for(var c=0;c<this.objects.length;c++){if(this.objects[c].constructor===KeyAction){a=a+this.objects[c].keyName+"\n"}}if(a.length!=""){a=lang_data.msg.pressKey+"\n"+a}}else{if(b==Menu_Action.editAction){a=this.activeEditBox.getAnswer()}}this.showAnswerTips();if(a!=""&&this.bScore){window.alert(a)}},SetExam:function(){if(this.next==-1){this.bInExam=false}else{this.bInExam=true}if(this.bScore&&this.haveEffectAction()==false){this.bCorrect=true}else{this.bCorrect=false}this.examinationTryNumb=0;this.bTimeout=false;this.bPrompt=false},setExamValues:function(b,a){if(this.haveEffectAction()==false){return}if(b){this.examinationTryNumb++;if((Common.HARD_LEVEL==1&&this.examinationTryNumb>1)||(Common.HARD_LEVEL==0&&this.bPrompt==true)){this.bCorrect=false}else{this.bCorrect=true}}else{if(a==Menu_Action.mouseAction&&!this.bPrompt){this.examinationTryNumb++;this.showAlert(a)}else{if(a==Menu_Action.editAction||a==Menu_Action.keyAction){if(!this.bPrompt){this.examinationTryNumb++}this.showAlert(a)}}}},showAlert:function(a){if(this.bScore){if(this.haveEffectAction()){lesson.pause();if(window.confirm(lang_data.msg.wrong.replace("_newLine_","\n"))){this.showAnswer(a)}lesson.play()}}else{this.showAnswer(a)}}};var Report=function(a){steps=a;contents=[];details=[]};Report.prototype={isShow:function(){if(Common.getReportElement().style.display=="block"){return true}else{return false}},hide:function(){Common.getReportElement().style.display=""},show:function(){Common.getReportElement().style.display="block"},getOperateTime:function(e){var b=0;var d=0;var a=0;var c=0;if(this.isExamTimeout==true&&Common.EXAM_INTERVAL!=undefined){b=Common.EXAM_INTERVAL*60}else{b=parseInt(e/1000)}d=parseInt(b/3600);a=parseInt(b/60%60);c=parseInt(b%60);return d+"h:"+a+"m:"+c+"s."},getTestDate:function(d){var b=new Array("January","February","March","April","May","June","July","August","September","October","November","December");var m=new Array("Sunday","Monday","Tuesday","Wednesday","Thursday","Friday","Saturday");var k=d.getHours();var e=d.getMinutes();var l=d.getSeconds();var a=d.getDate();var g=d.getFullYear();var i=d.getDay();var c=m[i];var h=d.getMonth();var f=b[h];if(k<10){k="0"+k}if(e<10){e="0"+e}if(l<10){l="0"+l}var j=c+","+a+" "+f+" "+g+" "+k+":"+e+":"+l;return j},getTotalExamStep:function(){var b=0;for(var a=0;a<steps.length;a++){if(steps[a].bInExam){++b}}return b},getTotalScoreStep:function(){var b=0;for(var a=0;a<steps.length;a++){if(steps[a].bInExam&&steps[a].bScore){++b}}return b},getCorrectStep:function(){var b=0;for(var a=0;a<steps.length;a++){if(steps[a].bTimeout){b=-1;break}if(steps[a].bInExam&&steps[a].bScore){if(steps[a].bCorrect){++b}}}return b},getIncorrectStep:function(){var a=0;for(var b=0;b<steps.length;b++){if(steps[b].bTimeout){a=-1;break}if(steps[b].bInExam&&steps[b].bScore){if(!steps[b].bCorrect){++a}}}return a},getIncorrectStepIdx:function(){var a="";for(var b=0;b<steps.length;b++){if(steps[b].bInExam&&steps[b].bScore){if(!steps[b].bCorrect){a+="["+(b+1)+"],"}}}if(a.length>0){a=a.substr(0,a.length-1)}return a},getCorrectStepForSB:function(){var b=0;for(var a=0;a<steps.length;a++){if(steps[a].bTimeout){break}if(steps[a].bInExam&&steps[a].bScore){if(steps[a].bCorrect){++b}}}return b},getScore:function(a,b){var c=0;if(a<=0){return 0}c=parseInt(((b*100*100)/a).toString())/100;return c},updateData:function(a){var A=Common.getReportElement();if(A.style.display=="block"){return}var x='<div id="leftDiv"><input class="btnReport" type="button" id="sendReport" /><input class="btnReport" type="button" id="retest" /><input class="btnReport" type="button" id="returnIndex" /></div>';var c='<div id="contentDiv"><table class="tableReport" id="reportTable">';var D='<tr><th align="left"></th><td colspan="2" align="left"></td></tr>';var l='<tr class="detailHead"><td colspan="3"></td></tr><tr><th></th><th></th><th></th></tr>';var E="<tr><td></td><td></td><td></td></tr>";var e="</table></div>";var n=this.getOperateTime(a);var k=this.getTotalExamStep();var w=this.getTotalScoreStep();var m=this.getCorrectStep();var q=this.getScore(w,m);var o=(Common.REQUIRE_LINE!=undefined&&Common.REQUIRE_LINE>0)?10:8;var f="";for(var C=0;C<o;C++){f+=D}var h="";for(var C=0;C<k;C++){h+=E}A.innerHTML=x+c+f+l+h+e;var v=this;function B(i){if(!i){i=WindowCaptured.event}if(Common.isScoreBook()){v.sendScoreBook()}else{v.sendMail();thisControlbar.GoBack()}}function d(i){thisControlbar.OnReplay()}function u(i){thisControlbar.GoBack()}var p=document.getElementById("sendReport");if(Common.MAIL!=undefined||Common.isScoreBook()){p.value=lang_data.report.sendReport;p.addEventListener("click",B,false)}else{p.style.display="none"}var y=document.getElementById("retest");y.value=lang_data.report.retest;y.addEventListener("click",d,false);var g=document.getElementById("returnIndex");if(Common.getMetaContent()=="index.html"){g.value=lang_data.report.returnIndex;g.addEventListener("click",u,false)}else{g.style.display="none"}contents=[];contents[0]=[lang_data.report.lessonName,Common.INFO_NAME];contents[1]=[lang_data.report.author,Common.INFO_AUTHOR];contents[2]=[lang_data.report.testDate,this.getTestDate(new Date())];contents[3]=[lang_data.report.operateTime,n];contents[4]=[lang_data.report.questionNum,m<0?Common.REPORT_NAN:w];contents[5]=[lang_data.report.correctNum,m<0?Common.REPORT_NAN:m];contents[6]=[lang_data.report.incorrectNum,m<0?Common.REPORT_NAN:(w-m)];if(Common.REQUIRE_LINE!=undefined&&Common.REQUIRE_LINE>0){contents[7]=[lang_data.report.acceptLine,Common.REQUIRE_LINE+lang_data.report.point];contents[8]=[lang_data.report.score,m<0?Common.REPORT_NAN:q+lang_data.report.point];if(m<0){contents[9]=[lang_data.report.judgement,lang_data.report.timeout]}else{if(q<Common.REQUIRE_LINE){contents[9]=[lang_data.report.judgement,lang_data.report.failed]}else{contents[9]=[lang_data.report.judgement,lang_data.report.passed]}}}else{contents[7]=[lang_data.report.score,m<0?Common.REPORT_NAN:q+lang_data.report.point]}var F=document.getElementById("reportTable");F.rows[o].cells[0].innerHTML=lang_data.report.detail;F.rows[o+1].cells[0].innerHTML=lang_data.report.stepID;F.rows[o+1].cells[1].innerHTML=lang_data.report.tryingNum;F.rows[o+1].cells[2].innerHTML=lang_data.report.perJudgement;details=[];var s=0;for(var C=0;C<steps.length;C++){if(steps[C].bInExam){var r=(steps[C].bScore==false||(steps[C].bScore&&steps[C].haveEffectAction()==false))?Common.REPORT_NAN:steps[C].examinationTryNumb;var b=(steps[C].bCorrect)?lang_data.report.correct:lang_data.report.incorrect;if(steps[C].bTimeout){b=lang_data.report.timeout}else{if(steps[C].bScore==false){b=Common.REPORT_NAN}}details[s++]=[steps[C].num,r,b,steps[C].bScore]}}for(var C=0;C<F.rows.length;C++){for(var z=0;z<F.rows[C].cells.length;z++){if(C<o){F.rows[C].cells[z].innerHTML=contents[C][z]}else{if(C>o+1){F.rows[C].cells[z].innerHTML=details[C-o-2][z]}}if(C%2==0&&C!=o){F.rows[C].className="blankRow"}}}},submitScormResult:function(a){try{var b=window.getAPIHandle();if(typeof b=="undefined"){alert("API object not found, tracking information not updated");return}var c=this.getTotalScoreStep();var d=this.getCorrectStep();var f=this.getScore(c,d);if(Common.INFO_SCORM_VERSION==1){window.doLMSSetValue("cmi.core.score.max",100);window.doLMSSetValue("cmi.core.score.min",0);if(a){window.doLMSSetValue("cmi.core.score.raw","0")}else{window.doLMSSetValue("cmi.core.score.raw",""+f)}}else{window.doSetValue("cmi.score.max",100);window.doSetValue("cmi.score.min",0);if(a){window.doSetValue("cmi.score.raw","0")}else{window.doSetValue("cmi.score.raw",f)}}}catch(g){alert("Update score error due to following reason:\r\n"+g)}},showScormData:function(){var d=this.getTotalScoreStep();var e=this.getCorrectStep();var a=this.getIncorrectStep();var f=this.getScore(d,e);var c=lang_data.report.info_scormresult;var b=this.getIncorrectStepIdx();c=c.replace(/<br>/g,"\n");c=c.replace("%stepCount%",d);c=c.replace("%incorrectCount%",a);c=c.replace("%correctRate%",f+"%");if(b!=""){c+=lang_data.report.incorrect_stepnum+b}alert(c)},transEnContents:function(a,b){if(Common.REQUIRE_LINE!=undefined&&Common.REQUIRE_LINE>0){if(a==7&&b==1){return contents[7][1].replace(lang_data.report.point,"Point")}if(a==8&&b==1){return contents[8][1].replace(lang_data.report.point,"Point")}if(a==9&&b==1){return contents[9][1].replace(lang_data.report.failed,"Rejection").replace(lang_data.report.passed,"Acceptance").replace(lang_data.report.timeout,"Timeout")}}else{if(a==7&&b==1){return contents[7][1].replace(lang_data.report.point,"Point")}}return contents[a][b]},transEnDetailsJudgement:function(a){return details[a][2].replace(lang_data.report.incorrect,"Not Correct").replace(lang_data.report.correct,"Correct").replace(lang_data.report.timeout,"Timeout")},sendMail:function(){var c="%0D%0A";var d="%09%09%09";var b="mailto:"+Common.MAIL+"?subject="+contents[0][1]+"-Report&body=BEGIN REPORT"+c;b+="Date: "+contents[2][1]+c;b+="Lesson Name: "+contents[0][1]+c;b+="Author: "+contents[1][1]+c;b+="Execution Time: "+contents[3][1]+c;b+="Number of Questions: "+contents[4][1]+c;b+="Number of Correct Answers: "+contents[5][1]+c;b+="Number of Incorrect Answers: "+contents[6][1]+c;if(Common.REQUIRE_LINE!=undefined&&Common.REQUIRE_LINE>0){b+="Acceptance Line: "+this.transEnContents(7,1)+c;b+="Score: "+this.transEnContents(8,1)+c;b+="Judgement: "+this.transEnContents(9,1)+c}else{b+="Score: "+this.transEnContents(7,1)+c}b+="Details: "+c;b+="Step ID    Number of Trials      Judgement "+c;for(var a=0;a<details.length;a++){b+=details[a][0]+d+details[a][1]+d+this.transEnDetailsJudgement(a)+c}b+="END REPORT"+c;window.location.href=b},sendScoreBook:function(){var b=scorebook_url;var c=new Date();var j=this.getTotalScoreStep();var a=this.getCorrectStepForSB();var h=this.getScore(j,a);var e="contents_code=4";e+="&lesson="+contents[0][1];e+="&user="+contents[1][1];e+="&test_date="+c.getFullYear()+"/"+(c.getMonth()+1)+"/"+c.getDate()+" "+c.getHours()+":"+c.getMinutes()+":"+c.getSeconds();e+="&jishi_time="+contents[3][1];e+="&mondai_su="+j;e+="&seikai_su="+a;e+="&fuseikai_su="+(j-a);e+="&tokuten="+h;if(contents[9]!=undefined){e+="&judge="+contents[9][1].replace(lang_data.report.failed,"Rejection").replace(lang_data.report.passed,"Acceptance").replace(lang_data.report.timeout,"outTime")}else{e+="&judge=Acceptance"}e+="&reportDetails=";for(var f=0;f<steps.length;f++){if(steps[f].bInExam){var d=(steps[f].bScore==false||(steps[f].bScore&&steps[f].haveEffectAction()==false))?"1":steps[f].examinationTryNumb;var g=(steps[f].bCorrect)?"Correct":"Not Correct";if(steps[f].bTimeout){g="Not Correct"}else{if(steps[f].bScore==false){g="Not Correct"}}e+=steps[f].num+","+d+","+(steps[f].bScore?"1":"0")+","+g+"."}}e+="&time="+new Date().getTime();if(mode_config==0){window.location.href=b+e}else{if(mode_config==1){this.ajaxToLMS(b,e)}}},ajaxToLMS:function(a,c){var b;if(window.XMLHttpRequest){b=new XMLHttpRequest()}else{b=new ActiveXObject("Microsoft.XMLHTTP")}b.onreadystatechange=function(){if(b.readyState==4){var f=document.getElementById("sendReport");f.style.cursor="default";if(b.status==200){if(b.responseText==""){alert(lang_data.report.info_failInvalid)}else{var e=JSON.parse(b.responseText);if(e=="success"){thisControlbar.GoBack()}if(e=="fail"){alert(lang_data.report.info_fail);f.disabled=false}else{if(e=="cannotentry"){alert(lang_data.report.info_cannotentry)}}}}else{alert(lang_data.report.info_fail);f.disabled=false}}};a=a.slice(0,-1);b.open("POST",a,true);b.setRequestHeader("Content-type","application/x-www-form-urlencoded");b.send(c);var d=document.getElementById("sendReport");d.style.cursor="wait";d.disabled=true}};window.requestNextFrame=(function(){var c=undefined,g=undefined,f=undefined,e=0,d=navigator.userAgent,b=0,a=this;if(window.webkitRequestAnimationFrame){g=function(h){a.callback()};c=window.webkitRequestAnimationFrame;window.webkitRequestAnimationFrame=function(i,h){a.callback=i;c(g,h)}}if(window.mozRequestAnimationFrame){b=d.indexOf("rv:");if(d.indexOf("Gecko")!=-1){e=d.substr(b+3,3);if(e==="2.0"){window.mozRequestAnimationFrame=undefined}}}return window.requestAnimationFrame||window.webkitRequestAnimationFrame||window.mozRequestAnimationFrame||window.oRequestAnimationFrame||window.msRequestAnimationFrame||function(k,i){var j,h;window.setTimeout(function(){j=+new Date();k();h=+new Date();a.timeout=1000/60-(h-j)},a.timeout)}})();var Lesson=function(d){var c=document.getElementById(d);self=this;this.context=c.getContext("2d");this.steps=[];this.curStepIndex=0;this.actionIndex=0;this.keyDownConunter=0;this.mode=Menu_Mode.index;this.keyListeners=[];this.isadaptive=true;this.videobjCount=0;this.imageLoadingProgressCallback;this.images={};this.imageUrls=[];this.imagesLoaded=0;this.imagesFailedToLoad=0;this.imagesIndex=0;this.durationStep=0;this.durationExam=0;this.time_Last=0;this.flag_Paused=false;this.flag_back_paused=false;this.ctrl_paused=false;this.time_ErrorMedia=0;this.bAddEventMedia=false;this.muted=false;this.report=new Report(this.steps);this.clikcActionType=ClickEventType.mouse;this.pointerDownTimeoutID;this.mouseActionStatus=MouseActionType.stop;this.touchStartX=undefined;this.touchStartY=undefined;this.isScormSubmit=false;var a=new Array();var b=0;window.onkeydown=function(g){if(self.keyDownConunter==0){self.keyDownConunter++;if(editsDiv.style.display=="none"&&self.mode!=0){var f=self.steps[self.curStepIndex];if(self.mode==Menu_Mode.exercise){f.addMockExamTryNumb()}if(self.actionIndex!=self.curStepIndex){self.actionIndex=self.curStepIndex}f.onKeyUp(g);f.actionResult.actionType=Menu_Action.keyAction;if(f.actionResult.eventResult==EventResult.Correctly){self.doActionResult(f.actionResult)}self.disposeEvent(g)}}};window.onkeyup=function(g){if(self.keyDownConunter!=0){var f=self.steps[self.curStepIndex];if(editsDiv.style.display=="none"&&self.actionIndex==self.curStepIndex&&self.mode!=0&&f.actionResult!=undefined&&f.actionResult.eventResult!=EventResult.Correctly){f.onKeyUp(g);f.actionResult.actionType=Menu_Action.keyAction;self.doActionResult(f.actionResult);self.disposeEvent(g)}self.keyDownConunter=0}};c.onmousedown=function(f){self.doMouseDown(f)};c.onmouseup=function(f){self.doMouseUp(f);if(f.button==2){self.mouseActionStatus==MouseActionType.running}};c.onclick=function(f){if((Common.CURRENT_EXPLORER==ExplorerInfo.IOS||Common.CURRENT_EXPLORER==ExplorerInfo.METRO_IE||Common.CURRENT_EXPLORER==ExplorerInfo.ANDROID)){self.onTouch(f.clientX,f.clientY)}};c.ondblclick=function(f){self.doMouseDbClick(f)};c.onmousemove=function(g){if(self.curStepIndex==-1){return}if(Common.CURRENT_EXPLORER==ExplorerInfo.DESKTOP_IE||Common.CURRENT_EXPLORER==ExplorerInfo.OTHERS){var f=self.windowToCanvas(g.clientX,g.clientY);self.steps[self.curStepIndex].onmousemove(self.context,f,self.mode);if(self.flag_Paused){self.gotoPos()}}};this.clickCount=0;this.touchStartEvent=0;this.touchEndEvent=0;editBox.onkeyup=function(f){if(editsDiv.style.display!="none"&&self.mode!=0&&self.actionIndex==self.curStepIndex&&f.keyCode!=16&&f.keyCode!=17&&f.keyCode!=18){self.doEditBoxInputAction(f)}};editBox.onkeydown=function(f){if(self.actionIndex!=self.curStepIndex){self.actionIndex=self.curStepIndex}if(f.keyCode==13&&editsDiv.style.display!="none"&&self.actionIndex==self.curStepIndex&&self.mode!=0){self.doEditBoxEnterDownAction(f);f.stopImmediatePropagation()}};return this};Lesson.prototype={PAUSE_TIMEOUT:100,init:function(b){this.mode=b;thisControlbar.ShowBar(b);for(var a=0;a<this.steps.length;a++){this.steps[a].init(b)}this.hideEndFrame();this.setStepIndex(0,0);this.keyListeners=[];this.time_Last=0;this.time_ErrorVideo=0;this.durationStep=0;this.durationExam=0;this.flag_Paused=false;this.ctrl_paused=false;this.bAddEventMedia=false;this.videobjCount=0;this.isScormSubmit=false;this.mouseActionStatus=MouseActionType.stop;if(Common.CURRENT_EXPLORER!=ExplorerInfo.IOS){this.initailizeEditTag()}this.clearScreen();if(this.mode!=Menu_Mode.index){this.start()}},loadDatas:function(d){var H=d.steps;for(var T=0;T<H.length;T++){var O=null;var V=H[T];var G=new Step(V.totalTime,V.imageBK,V.x,V.y,V.pro,V.next,V.num,V.bScore);if(V.imageBK){for(var S=0;S<V.imageBK.length;S++){this.queueImage(V.imageBK[S].src)}}if(V.zoompans!==undefined){var I=[1,0,0];for(var S=0;S<V.zoompans.length;S++){var q=V.zoompans[S];q.x=-q.x;q.y=-q.y;q.lastParam=[];q.lastParam[0]=I[0];q.lastParam[1]=I[1];q.lastParam[2]=I[2];var f=new ZoomPan(q);G.zoomPans.push(f);I[0]=f.scale;I[1]=f.point.x*f.scale;I[2]=f.point.y*f.scale}}var w=V.keyActions;if(w!==undefined){for(var S=0;S<w.length;S++){var t=w[S];var s=new KeyAction(t);G.objects.push(s)}}if(V.mouseActions!==undefined){for(var S=0;S<V.mouseActions.length;S++){var r=new MouseAction(V.mouseActions[S]);G.objects.push(r)}}if(V.notes!==undefined){for(var S=0;S<V.notes.length;S++){var A=new Note(V.notes[S]);this.queueImage(V.notes[S].img);G.objects.push(A)}}if(V.promptBoxes!==undefined){for(var S=0;S<V.promptBoxes.length;S++){var b=new PromptBox(V.promptBoxes[S]);this.queueImage(V.promptBoxes[S].img);this.queueImage(V.promptBoxes[S].imgInfo);G.objects.push(b)}}if(V.editBoxes!==undefined){for(var S=0;S<V.editBoxes.length;S++){var a=new EditBox(V.editBoxes[S]);G.objects.push(a)}}if(V.mouseRoutes!==undefined){for(var S=0;S<V.mouseRoutes.length;S++){var g,c=0,E,n,h,p,z,L,K,D=false;var W=[];for(var R=0;R<V.mouseRoutes[S].mouseRoute.length;R++){var C=V.mouseRoutes[S].mouseRoute[R];if(C.x!==undefined){L=C.x}if(C.y!==undefined){K=C.y}W[R]=new Point(L,K)}var J=new Bezier(W);var B=[];for(var R=0;R<V.mouseRoutes[S].mouseRoute.length;R++){var C=V.mouseRoutes[S].mouseRoute[R];if(C.img!==undefined){g=C.img}if(C.startTime!==undefined){c=C.startTime}if(C.totalTime!==undefined){E=C.totalTime}if(C.sx!==undefined){n=C.sx}if(C.sy!==undefined){h=C.sy}if(C.sw!==undefined){p=C.sw}if(C.sh!==undefined){z=C.sh}if(C.x!==undefined){L=C.x}if(C.y!==undefined){K=C.y}if(C.iStepRoute!==undefined){D=C.iStepRoute}if(R<V.mouseRoutes[S].mouseRoute.length-1){var P=60;var l=Math.round(E/P)+1;var o=J.computePointsInCurve(R,l);var N=c;for(var Q=0;Q<o.length;Q++){var U=new Route();U.startTime=N;U.totalTime=P;U.sx=n;U.sy=h;U.sw=p;U.sh=z;U.x=o[Q].x;U.y=o[Q].y;B.push(U);N+=P}}else{var U=new Route();U.startTime=c;U.totalTime=E;U.sx=n;U.sy=h;U.sw=p;U.sh=z;U.x=L;U.y=K;B.push(U)}c+=E}var e=new MouseRoute(B,g,D);if(D){O=e}else{G.objects.push(e)}this.queueImage(g)}}var F=V.buttons;if(F!==undefined){for(var S=0;S<F.length;S++){var v=new Button(F[S]);G.objects.push(v)}}if(V.spotlights!==undefined){for(var S=0;S<V.spotlights.length;S++){var E=V.spotlights[S].totalTime!=-1?V.spotlights[S].totalTime:V.totalTime;V.spotlights[S].totalTime=E;var M=new Spotlights(V.spotlights[S]);this.queueImage(V.spotlights[S].img);G.objects.push(M)}}if(V.videObjs!=undefined){for(var S=0;S<V.videObjs.length;S++){this.videobjCount++;var u=new VideObj(V.videObjs[S]);G.objects.push(u)}}G.objects.sort(Common.compare("layer"));if(O!=null){G.objects.push(O)}this.steps.push(G)}},doMouseDown:function(c){if(Common.CURRENT_EXPLORER==ExplorerInfo.DESKTOP_IE||Common.CURRENT_EXPLORER==ExplorerInfo.OTHERS){var a=self.windowToCanvas(c.clientX,c.clientY);var b=self.steps[self.curStepIndex];b.onmousedown(self.context,a,c,self.mode);b.actionResult.actionType=Menu_Action.mouseAction;if(self.mode!=0){if(self.actionIndex!=self.curStepIndex){self.actionIndex=self.curStepIndex}self.mouseActionStatus=MouseActionType.running;if(b.actionResult.eventResult==EventResult.Correctly){self.mouseActionStatus=MouseActionType.stop;if(self.mode==Menu_Mode.exercise){self.steps[self.curStepIndex].addMockExamTryNumb()}self.doActionResult(b.actionResult)}else{if(b.actionResult.eventResult==EventResult.PointInEditBox){self.enableEditTag(b.activeEditBox)}else{if(editsDiv.style.display!="none"){editsDiv.style.display="none"}b.disposeActiveEditBox()}}}}},doMouseUp:function(c){if(self.mouseActionStatus==MouseActionType.running){var b=self.steps[self.curStepIndex];var a=self.windowToCanvas(c.clientX,c.clientY);b.onmousedown(self.context,a,c,self.mode);b.actionResult.actionType=Menu_Action.mouseAction;if(b.actionResult.eventResult==EventResult.Correctly||b.actionResult.eventResult==EventResult.Incorrectly){self.mouseActionStatus=MouseActionType.stop;if(self.mode==Menu_Mode.exercise){self.steps[self.curStepIndex].addMockExamTryNumb()}self.doActionResult(b.actionResult)}}},doMouseClick:function(a){},doMouseDbClick:function(c){var b=self.steps[self.curStepIndex];if(self.mouseActionStatus==MouseActionType.running){var a=self.windowToCanvas(c.clientX,c.clientY);b.onmousedown(self.context,a,c,self.mode);b.actionResult.actionType=Menu_Action.mouseAction;if(b.actionResult.eventResult==EventResult.Correctly||b.actionResult.eventResult==EventResult.Incorrectly){self.mouseActionStatus=MouseActionType.stop;if(self.mode==Menu_Mode.exercise){self.steps[self.curStepIndex].addMockExamTryNumb()}}self.doActionResult(b.actionResult)}},onTouch:function(c,a){if(editsDiv.style.display!="none"){editsDiv.style.display="none"}var b=self.windowToCanvas(c,a);var d=self.steps[self.curStepIndex];d.ontouchclick(self.context,b,self.mode);d.actionResult.actionType=Menu_Action.mouseAction;if(d.actionResult.eventResult==EventResult.Correctly||d.actionResult.eventResult==EventResult.Incorrectly){if(self.mode==Menu_Mode.exercise){self.steps[self.curStepIndex].addMockExamTryNumb()}self.doActionResult(d.actionResult)}else{if(d.actionResult.eventResult==EventResult.PointInEditBox){self.enableEditTag(d.activeEditBox)}else{if(editsDiv.style.display!="none"){editsDiv.style.display="none"}d.disposeActiveEditBox()}}},doMouseAction:function(d){if(self.actionIndex!=self.curStepIndex||self.mode==0){return}var a=self.windowToCanvas(d.clientX,d.clientY);var c=self.steps[self.curStepIndex];var b=c.onmousedown(self.context,a,d,self.mode);b.actionType=Menu_Action.mouseAction;if(b.eventResult==EventResult.Correctly||b.eventResult==EventResult.Incorrectly){self.mouseActionStatus=MouseActionType.stop;if(self.mode==Menu_Mode.exercise){self.steps[self.curStepIndex].addMockExamTryNumb()}}self.doActionResult(b);self.disposeEvent(d)},doKeyAction:function(c){if(self.mode==Menu_Mode.exercise){self.steps[self.curStepIndex].addMockExamTryNumb()}var b=self.steps[self.curStepIndex];var a=b.onKeyUp(c);a.actionType=Menu_Action.keyAction;self.doActionResult(a);self.disposeEvent(c)},doEditBoxInputAction:function(b){var a=self.steps[self.curStepIndex];if(a.activeEditBox!=null&&a.activeEditBox.isEnglish){if(self.mode==Menu_Mode.exercise){self.steps[self.curStepIndex].addMockExamTryNumb()}a.onInput(b);a.actionResult.actionType=Menu_Action.editAction;self.doActionResult(a.actionResult);self.disposeEvent(b)}},doEditBoxEnterDownAction:function(b){if(self.mode==0){return}var a=self.steps[self.curStepIndex];if(a.activeEditBox!=null&&!a.activeEditBox.isEnglish){if(self.mode==Menu_Mode.exercise){self.steps[self.curStepIndex].addMockExamTryNumb()}a.onEnterKeyDown(b);a.actionResult.actionType=Menu_Action.editAction;self.doActionResult(a.actionResult);self.disposeEvent(b)}},doActionResult:function(c){var b=self.steps[self.curStepIndex];if(c.eventResult==EventResult.Correctly){if(self.mode==Menu_Mode.examination){b.setExamValues(true,c.actionType)}self.gotoStep(c.next)}else{if(c.eventResult==EventResult.Incorrectly){if(self.mode==Menu_Mode.examination){b.setExamValues(false,c.actionType)}if(self.mode==Menu_Mode.exercise&&self.steps[self.curStepIndex].mockExaminationTryNumb>=Common.MAXTRIES){var d=lang_data.msg.goBackToMode2.replace("_n_",self.steps[self.curStepIndex].mockExaminationTryNumb);self.pause();if(window.confirm(d)){var a=self.curStepIndex;self.init(1);self.gotoStep(a)}else{self.play()}}}}},disposeEvent:function(a){if(a&&a.preventDefault){a.preventDefault()}else{window.event.returnValue=false}},loadImage:function(b){var c=new Image(),a=this;c.src=Common.DATA_PATH+b;c.addEventListener("load",function(d){a.imagesLoaded++});c.addEventListener("error",function(d){a.imagesFailedToLoad++});this.images[b]=c},loadImages:function(){if(this.imageUrls.length==0){return 100}if(this.imagesIndex<this.imageUrls.length){this.loadImage(this.imageUrls[this.imagesIndex]);this.imagesIndex++}return(this.imagesLoaded+this.imagesFailedToLoad)/this.imageUrls.length*100},queueImage:function(a){this.imageUrls.push(a)},getDuration_Step:function(a){var c=0;for(var b=0;b<this.steps.length;b++){c+=this.steps[b].totalTime;if(a<=c){return(a-(c-this.steps[b].totalTime))}}return 0},getDuration_OverSteps:function(c){var a=0;for(var b=0;b<c;b++){a+=this.steps[b].totalTime}return a},getStepIndex:function(a){var c=0;for(var b=0;b<this.steps.length;b++){c+=this.steps[b].totalTime;if(a<=c){return b}}},getCurStepIndex:function(a){var b=this.curStepIndex;switch(a){case"first":b=0;break;case"pre":b=this.steps[b].pro;break;case"next":b=this.steps[b].next;break;case"last":b=this.steps.length-1;break}return b},gotoStep:function(a){if(a==undefined||a<0||a>=this.steps.length){return}this.gotoPos(a,0);this.initailizeEditTag();if(!this.ctrl_paused){this.play()}},gotoPos:function(a,b){this.context.save();if(a==undefined&&b==undefined){this.updateData()}else{this.setStepIndex(a,b)}this.beforePaint(this.curStepIndex,this.durationStep);this.paint();this.afterPaint(this.curStepIndex,this.durationStep);this.context.restore()},updateData:function(){if(!this.isInStep(this.curStepIndex,this.durationStep)&&this.steps[this.curStepIndex].next!=-1){if(this.mode>Menu_Mode.auto&&this.steps[this.curStepIndex].haveEffectAction()){return}this.setStepIndex(this.steps[this.curStepIndex].next)}},clearScreen:function(){this.context.clearRect(0,0,Common.LESSON_WIDTH,Common.LESSON_HEIGHT)},displayEndFrame:function(){if(this.isEnd()&&!this.flag_Paused){return}if(this.mode!=Menu_Mode.examination){var b=document.getElementById("endframe");if(b!=null){var a=false;if(this.steps[this.curStepIndex].next==-1){a=true;if(Common.isScoreBook()&&!this.isEnd()){this.sendMsgToSB()}}b.style.display=a?"block":"none"}}else{if(this.report.isShow()){return}var c=this.durationExam+this.durationStep-100;if(Common.EXAM_INTERVAL!==undefined&&c/1000>(Common.EXAM_INTERVAL*60)){window.alert(lang_data.msg.timeout);this.steps[this.curStepIndex].bTimeout=true;this.steps[this.curStepIndex].setExamValues(false,Menu_Action.unknown);c=Common.EXAM_INTERVAL*60000}if(this.steps[this.curStepIndex].bTimeout||this.steps[this.curStepIndex].next==-1){if(!Common.isScorm()){this.report.updateData(c);this.report.show()}else{if(this.steps[this.curStepIndex].bTimeout){this.submitScormData()}}}}if(this.isEnd()||(Common.isScorm()&&this.mode==Menu_Mode.examination&&this.steps[this.curStepIndex].next==-1)){thisControlbar.OnPause()}},hideEndFrame:function(){this.report.hide();document.getElementById("endframe").style.display=""},isEnd:function(){if(document.getElementById("endframe").style.display=="block"||this.report.isShow()){return true}else{return false}},paint:function(){this.steps[this.curStepIndex].paint(this.context,this.durationStep,this.mode);this.displayEndFrame()},isInStep:function(a,b){if(b>=0&&b<=this.steps[a].totalTime){return true}else{return false}},setStepIndex:function(a,b){canvasLoader.setState(Menu_LoadFlag.ok);if(a!=this.curStepIndex){this.steps[this.curStepIndex].clear();this.curStepIndex=a;this.bAddEventMedia=false;this.time_ErrorMedia=0;this.durationExam+=this.durationStep;this.clearScreen()}this.steps[a].SetExam();this.steps[a].onResume();if(b===undefined){b=0}this.durationStep=b;this.time_Last=Common.getTimeNow()},beforePaint:function(a,b){},afterPaint:function(a,b){},start:function(){var a=this;window.requestNextFrame(function(){a.animate.call(a)})},pauseOrPlay:function(){if(this.flag_Paused){this.play()}else{this.pause()}},pause:function(){if(this.curStepIndex==-1){return}if(!this.flag_Paused){this.flag_Paused=true;this.steps[this.curStepIndex].pause();canvasLoader.setState(Menu_LoadFlag.ok)}},play:function(){if(this.curStepIndex==-1){return}if(this.flag_Paused){this.flag_Paused=false;this.time_Last=Common.getTimeNow();this.steps[this.curStepIndex].play()}},sound:function(a){if(a=="on"){this.muted=false}else{if(a=="off"){this.muted=true}}},animate:function(){var a=this;if(this.flag_Paused){setTimeout(function(){window.requestNextFrame(function(){if(Common.isScorm()&&a.isEnd()&&!a.isScormSubmit&&a.mode!=Menu_Mode.examination){alert(lang_data.report.info_completion);if(a.isScormCompleted()){a.setScormCompleted()}a.isScormSubmit=true}else{if(Common.isScorm()&&!a.isScormSubmit&&a.mode==Menu_Mode.examination){a.submitScormData()}}a.animate.call(a)});if(a.mode!=Menu_Mode.index){a.paint()}},this.PAUSE_TIMEOUT)}else{if(a.mode!=Menu_Mode.index&&!a.isEnd()){if(!this.flag_back_paused){var b=Common.getTimeNow();if(this.time_Last!=0&&this.steps[this.curStepIndex].next==-1){b=this.time_Last}if(this.time_Last!=0){this.durationStep+=b-this.time_Last}this.time_Last=b}this.gotoPos()}window.requestNextFrame(function(){a.animate.call(a)})}},initailizeEditTag:function(){var a=this.steps[this.curStepIndex];a.InitailizeEditBox();if(a.activeEditBox==null||this.mode==0){if(editsDiv.style.display!="none"){editsDiv.style.display="none"}a.disposeActiveEditBox()}else{self.enableEditTag(a.activeEditBox)}},enableEditTag:function(a){Common.FOCUS_EDIT_BOX=a;if(editsDiv.style.display=="none"){editsDiv.style.display="block"}self.locateEditTag(a);editBox.style.fontSize=editBox.clientHeight*a.fontRatio;editBox.value="";if(Common.CURRENT_EXPLORER!=ExplorerInfo.DESKTOP_IE){setTimeout(function(){editBox.focus()},0)}},locateEditTag:function(c){var e=((c.point.x*Common.CANVAS_SCALE+Common.CANVAS_SCALE_X)/Common.LESSON_WIDTH*100).toFixed(2)+"%";var d=((c.point.y*Common.CANVAS_SCALE+Common.CANVAS_SCALE_Y)/Common.LESSON_HEIGHT*100).toFixed(2)+"%";var b=((c.width*Common.CANVAS_SCALE)/Common.LESSON_WIDTH*100).toFixed(2)+"%";var a=((c.height*Common.CANVAS_SCALE)/Common.LESSON_HEIGHT*100).toFixed(2)+"%";if(editsDiv.style.left!=e||editsDiv.style.top!=d||editsDiv.style.width!=b||editsDiv.style.height!=a){editsDiv.style.left=e;editsDiv.style.top=d;editsDiv.style.width=b;editsDiv.style.height=a}},windowToCanvas:function(a,c){var b=this.context.canvas.getBoundingClientRect();return new Point(a-b.left*(this.context.canvas.width/b.width),c-b.top*(this.context.canvas.height/b.height))},onResize:function(b,a){this.scaleAdaptive();if(this.mode!=Menu_Mode.index){this.steps[this.curStepIndex].onResize(b,a);this.beforePaint(this.curStepIndex,this.durationStep);this.paint();this.afterPaint(this.curStepIndex,this.durationStep)}},scaleAdaptive:function(){var a=Common.LESSON_WIDTH*Common.SCALE_RATIO;var b=Common.LESSON_HEIGHT*Common.SCALE_RATIO;if(this.context.canvas.width!=a||this.context.canvas.height!=b){this.context.canvas.width=a;this.context.canvas.height=b}this.context.scale(Common.SCALE_RATIO,Common.SCALE_RATIO)},sendMsgToSB:function(){var a=null;if(window.ActiveXObject){a=new ActiveXObject("Microsoft.XMLHTTP")}else{if(window.XMLHttpRequest){a=new XMLHttpRequest()}}var b=scorebook_url+"contents_code="+(this.mode+1)+"&"+new Date().getTime();a.open("GET",b);a.send(null)},isScormCompleted:function(){if(typeof(Common.INFO_SCORM_COMPMODE)!="undefined"&&Common.INFO_SCORM_COMPMODE==self.mode){return true}else{return false}},setScormCompleted:function(){var a=window.getAPIHandle();if(typeof a=="undefined"){alert("API object not found, tracking information not updated");return}if(Common.INFO_SCORM_VERSION==1){window.doLMSSetValue("cmi.core.lesson_status","completed");window.doLMSCommit()}else{window.doSetValue("cmi.completion_status","completed");window.doCommit()}},submitScormData:function(){if(this.steps[this.curStepIndex].bTimeout||this.steps[this.curStepIndex].next==-1){if(!this.steps[this.curStepIndex].bTimeout){this.report.showScormData()}if(this.isScormCompleted()){this.report.submitScormResult(this.steps[this.curStepIndex].bTimeout);this.setScormCompleted()}thisControlbar.GoBack();this.isScormSubmit=true}}};if(Common.checkHtml5()){var lesson=new Lesson(Common.CANVAS_ID);var canvasLoader=new CanvasLoader("canvasloader-container");mainCanvas=document.getElementById("main");btn_auto=document.getElementById("btn-mode-auto");btn_lecture=document.getElementById("btn-mode-lecture");btn_exercise=document.getElementById("btn-mode-exercise");btn_examination=document.getElementById("btn-mode-examination");btn_name_auto=document.getElementById("btn_name_auto");btn_name_lecture=document.getElementById("btn_name_lecture");btn_name_exercise=document.getElementById("btn_name_exercise");btn_name_examination=document.getElementById("btn_name_examination");ef_refresh=document.getElementById("ef_refresh");ef_return=document.getElementById("ef_return");modePage=document.getElementById("modePage");editBox=document.getElementById("editBox");editsDiv=document.getElementById("editsDiv");modepage_lessonName=document.getElementById("modepage_lessonName");modepage_testDate=document.getElementById("modepage_testDate");modepage_acceptLine=document.getElementById("modepage_acceptLine");loadingok=false;percentComplete=0;index_progressbar=document.getElementById("index-progress-bar");index_progressbar_p=document.getElementById("index-progress-p");setMode=function(a){if(a==-1){modePage.style.display="block";mainCanvas.style.display="none"}else{modePage.style.display="none";mainCanvas.style.display="block"}lesson.init(a)};function showModeBtn(a){if(a.mode0){btn_auto.onclick=function(b){startLesson(0)}}else{btn_auto.style.display="none";btn_name_auto.style.display="none"}if(a.mode1){btn_lecture.onclick=function(b){startLesson(1)}}else{btn_lecture.style.display="none";btn_name_lecture.style.display="none"}if(a.mode2){btn_exercise.onclick=function(b){startLesson(2)}}else{btn_exercise.style.display="none";btn_name_exercise.style.display="none"}if(a.mode3){btn_examination.onclick=function(b){startLesson(3)}}else{btn_examination.style.display="none";btn_name_examination.style.display="none"}btn_name_auto.innerHTML=lang_data.modePage.mode0;btn_name_lecture.innerHTML=lang_data.modePage.mode1;btn_name_exercise.innerHTML=lang_data.modePage.mode2;btn_name_examination.innerHTML=lang_data.modePage.mode3}function startLesson(g){var f=null,c=null,j=null,d=null,e=0,a=0,i=0,h=0;if(lesson.steps[0].imageBK.length>0){var b=lesson.steps[0].imageBK[0].imgname;e=lesson.steps[0].imageBK[0].imgwidth;a=lesson.steps[0].imageBK[0].imgheight;i=lesson.steps[0].imageBK[0].point.x;h=lesson.steps[0].imageBK[0].point.y;if(b!=undefined){f="url("+Common.DATA_PATH+b+")"}}switch(g){case 0:c=btn_auto;j="mode_btn mode_btn_auto magictime indexicon-auto";d="autoFullCanvas";break;case 1:c=btn_lecture;j="mode_btn mode_btn_lecture magictime indexicon-lecture";d="lectureFullCanvas";break;case 2:c=btn_exercise;j="mode_btn mode_btn_exercise magictime indexicon-exercise";d="exerciseFullCanvas";break;case 3:c=btn_examination;j="mode_btn mode_btn_examination magictime indexicon-examination";d="examinationFullCanvas";break}if(f!=null){c.style.backgroundImage=f;if(Common.LESSON_WIDTH!=e&&Common.LESSON_HEIGHT!=a){c.style.backgroundRepeat="no-repeat";c.style.backgroundSize=(e*Common.SCALE_RATIO)+"px "+(a*Common.SCALE_RATIO)+"px";c.style.backgroundPosition=(i*Common.SCALE_RATIO)+"px "+(h*Common.SCALE_RATIO)+"px"}else{c.style.backgroundSize="cover"}}c.className=j+" "+d;setTimeout(function(){setMode(g);c.className=j;c.style.removeProperty("background-image");c.style.removeProperty("background-size")},500)}function getInfoItemHtml(a,b){return'<div class="lesson_info_item leftinfo">'+a+'</div><div class="lesson_info_item rightinfo">'+b+"</div>"}lesson.afterPaint=function(a,b){if(isNaN(b)){b=0}if(b<=lesson.steps[a].totalTime){thisControlbar.UpdateProgressbarS(b)}else{thisControlbar.UpdateProgressbarS(lesson.steps[a].totalTime)}};ef_refresh.onclick=function(){thisControlbar.OnReplay()};ef_return.onclick=function(){if(!Common.IS_INDEX){return}thisControlbar.GoBack()};function showIndexProgressbar(){index_progressbar.style.display="block"}function hideIndexProgressbar(){index_progressbar.style.display="none";drawIndexProgressbar(0)}function drawIndexProgressbar(a){index_progressbar_p.style.width=a+"%"}function startProgressbar(){var a=setInterval(function(c){var b=lesson.loadImages();drawIndexProgressbar(b);if(b>=100){clearInterval(a);setTimeout(function(){hideIndexProgressbar();loadingok=true;prepareMedia();switch(Common.getMetaContent()){case"auto.html":setMode(0);mainCanvas.style.display="block";break;case"operationlecture.html":setMode(1);mainCanvas.style.display="block";break;case"operationexercise.html":setMode(2);mainCanvas.style.display="block";break;case"operationexam.html":setMode(3);mainCanvas.style.display="block";break;case"index.html":modePage.style.display="block";break;default:modePage.style.display="block";break}if((Common.IS_IPHONE||Common.IS_IPAD)&&Common.IS_INDEX==false){thisControlbar.OnPause()}},1000)}},16)}function prepareMedia(){if(Common.VER_IOS>0||Common.CURRENT_EXPLORER==ExplorerInfo.ANDROID){var a=window;if(Common.IS_INDEX==false){document.getElementById(Common.CANVAS_ID).style.display="none";document.getElementById("iosplay").style.display="block";a=document.getElementById("iosplay")}a.addEventListener("click",function(b){if(document.getElementById("iosplay").style.display=="block"){document.getElementById(Common.CANVAS_ID).style.display="block";document.getElementById("iosplay").style.display="none";thisControlbar.OnPlay();lesson.initailizeEditTag()}a.removeEventListener("click",arguments.callee,false);CreateMediaPool(lesson.videobjCount)},false)}else{CreateMediaPool(lesson.videobjCount)}}function returnBtnDisabled(a){if(!a){ef_return.className+=" btn_disabled"}}lesson.loadDatas(lesson_data);showModeBtn(lesson_data.info.modes);returnBtnDisabled(Common.IS_INDEX);modepage_lessonName.innerHTML=getInfoItemHtml(lang_data.report.lessonName,lesson_data.info.name);modepage_testDate.innerHTML=getInfoItemHtml(lang_data.report.testDate,lesson_data.info.strDate);if(lesson_data.info.requireLine!=undefined){modepage_acceptLine.innerHTML=getInfoItemHtml(lang_data.report.acceptLine,lesson_data.info.requireLine)}var thisControlbar=new ControlBar(lesson);thisControlbar.InitBar()}else{var errorMsg=document.getElementById("errorMsg");errorMsg.innerHTML=lang_data.msg.errorHtml5;errorMsg.style.display="block"}function LoadSize(){Resize()}function getScrollbarWidth(){if(Common.IS_IPHONE||Common.IS_IPAD){return 0}var d=document.createElement("p"),c={width:"100px",height:"100px",overflowY:"scroll"},a,b;for(a in c){d.style[a]=c[a]}document.body.appendChild(d);b=d.offsetWidth-d.clientWidth;document.body.removeChild(d);return b}function Resize(){if(!Common.checkHtml5()){return}if(lesson.isadaptive){var m=document.body;var l=document.getElementById("dojoBody");var f=getScrollbarWidth();var a=document.body.clientWidth;var b=document.body.clientHeight;var i=(a*0.015)-2;if(m.scrollLeft>0){a+=f}if(m.scrollTop>0){b+=f}var k=a-i;var g=b-i;Common.SCALE_RATIO=Common.getScaleRatio(k,g)}else{Common.SCALE_RATIO=1}var h=document.getElementById("dojoBody").style;Common.autoResize(k,g,h);var j=document.getElementById("modePage").style;var e=Common.autoResize(k,g,j);Common.refontsize("mode_btn",e.width,0.12);Common.refontsize("mode_btn_name",e.width,0.02);Common.refontsize("lesson_info_item",e.width,0.02);Common.refontsize("end_button",e.width,0.08);thisControlbar.OnResize(e.width);Common.refontsize("btnReport",e.width,0.015);Common.refontsize("tableReport",e.width,0.01);ResizeIndex(e.width,e.height);j=document.getElementById("main").style;Common.autoResize(k,g,j);var d=Common.getReportElement();j=document.getElementById("reportContent").style;Common.autoResize(k,g,j);lesson.onResize(k,g);var c=Common.LESSON_WIDTH>Common.LESSON_HEIGHT?Common.LESSON_HEIGHT:Common.LESSON_WIDTH;canvasLoader.setDiameter(Common.SCALE_RATIO*c*45/768);if(!loadingok){showIndexProgressbar();startProgressbar()}}function ResizeIndex(t,g){var d=0.6;var o=0.15;var q=0.04;var c=0.03;var s=0.12;var f=g*d;var p=t*o;var j=(g*q)+10;var h=g*c;var r=(f-p-h-j)/2;var m=r+p+h;var b=t*s;var a=(g-b)/2;var e=document.getElementsByClassName("mode_btn");for(var l=0;l<e.length;l++){e[l].style.top=r+"px";e[l].style.height=p+"px"}var k=document.getElementsByClassName("mode_btn_name");for(var l=0;l<k.length;l++){k[l].style.top=m+"px"}var n=document.getElementsByClassName("end_button");for(var l=0;l<n.length;l++){n[l].style.marginTop=a+"px"}};